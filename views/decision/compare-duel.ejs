<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stratejik Karşılaştırma - Head-to-Head Analiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-dark: #050709;
      --bg-panel: #0a0d12;
      --bg-card: #111318;
      --bg-input: #1a1d24;
      --border: #252931;
      --accent: #00d4ff;
      --accent-glow: rgba(0,212,255,0.3);
      --success: #00ff88;
      --success-glow: rgba(0,255,136,0.3);
      --warning: #ffaa00;
      --warning-glow: rgba(255,170,0,0.3);
      --danger: #ff4466;
      --danger-glow: rgba(255,68,102,0.3);
      --text: #e8eaed;
      --text-dim: #6b7280;
      --purple: #a855f7;
      --cyan: #06b6d4;
      --country-a: #00d4ff;
      --country-a-bg: rgba(0,212,255,0.1);
      --country-b: #a855f7;
      --country-b-bg: rgba(168,85,247,0.1);
    }

    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      max-width: 100vw;
    }

    .lucide {
      width: 1em;
      height: 1em;
      vertical-align: -0.125em;
    }

    .mono { font-family: 'JetBrains Mono', monospace; }

    /* ==================== TOPBAR ==================== */
    .topbar {
      background: linear-gradient(180deg, var(--bg-panel) 0%, transparent 100%);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      padding: 8px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      text-decoration: none;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .back-btn:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .page-title {
      font-size: 20px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .page-title .icon {
      font-size: 28px;
    }

    .vs-badge {
      background: var(--bg-input);
      border: 1px solid var(--border);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }

    .vs-badge.active {
      background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(168,85,247,0.2));
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ==================== SELECTOR HEADER (TRIPLE) ==================== */
    .selector-header.triple {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 24px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
    }

    .sector-selector-box {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.08), rgba(168, 85, 247, 0.08));
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 12px;
    }

    .selector-label.sector {
      color: var(--accent);
      font-size: 11px;
      white-space: nowrap;
    }

    .sector-select-main {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sector-select-main:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
      outline: none;
    }

    .sector-badge {
      padding: 6px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 11px;
      color: var(--text-dim);
      display: none;
    }

    .sector-badge.show {
      display: block;
    }

    .countries-row {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 24px;
      align-items: center;
    }

    .selector-header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 24px;
      padding: 24px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .country-selector {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .selector-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
    }

    .selector-label.a { color: var(--country-a); }
    .selector-label.b { color: var(--country-b); }

    .country-select {
      padding: 14px 18px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .country-select.a:focus { border-color: var(--country-a); box-shadow: 0 0 0 4px var(--country-a-bg); }
    .country-select.b:focus { border-color: var(--country-b); box-shadow: 0 0 0 4px var(--country-b-bg); }

    .vs-divider {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .vs-text {
      font-size: 28px;
      font-weight: 600;
      color: var(--text-dim);
    }

    .compare-btn {
      padding: 10px 24px;
      background: linear-gradient(135deg, var(--accent), var(--cyan));
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .compare-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    /* ==================== MAIN CONTENT ==================== */
    .duel-content {
      padding: 24px;
      display: none;
      max-width: 100%;
      overflow-x: hidden;
    }

    .duel-content.show { display: block; }

    /* Sector Context Banner */
    .sector-context-banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(168, 85, 247, 0.1));
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .sector-context-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sector-context-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      padding: 4px 10px;
      background: var(--bg-input);
      border-radius: 4px;
    }

    .sector-context-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .sector-context-right {
      display: flex;
      align-items: center;
    }

    .sector-winner-verdict {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .sector-winner-verdict.winner-a {
      border-color: rgba(0, 212, 255, 0.5);
      background: rgba(0, 212, 255, 0.1);
    }

    .sector-winner-verdict.winner-b {
      border-color: rgba(168, 85, 247, 0.5);
      background: rgba(168, 85, 247, 0.1);
    }

    .sector-winner-verdict.tie {
      border-color: rgba(255, 170, 0, 0.5);
      background: rgba(255, 170, 0, 0.1);
    }

    .sector-winner-verdict .verdict-icon {
      font-size: 20px;
    }

    .sector-winner-verdict .verdict-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    /* ==================== SCORE HEADER ==================== */
    .score-header {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
      gap: 24px;
      margin-bottom: 32px;
      max-width: 100%;
    }

    .country-score-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .country-score-card.a { border-color: rgba(0,212,255,0.3); }
    .country-score-card.b { border-color: rgba(168,85,247,0.3); }

    .country-score-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .country-score-card.a::before { background: linear-gradient(90deg, var(--country-a), var(--cyan)); }
    .country-score-card.b::before { background: linear-gradient(90deg, var(--purple), var(--country-b)); }

    .winner-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.4);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #10b981;
      display: none;
    }

    .winner-badge.show { display: flex; align-items: center; gap: 6px; }

    .country-flag {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .country-name {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .country-region {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 16px;
    }

    .score-display {
      font-size: 56px;
      font-weight: 900;
      line-height: 1;
      margin-bottom: 8px;
    }

    .country-score-card.a .score-display { color: var(--country-a); }
    .country-score-card.b .score-display { color: var(--country-b); }

    .score-label {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .vs-center {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .vs-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 3px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 900;
      color: var(--text-dim);
    }

    /* ==================== COMPARISON SECTIONS ==================== */
    .comparison-section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title .icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .section-title .icon.cost { background: rgba(0,212,255,0.15); }
    .section-title .icon.market { background: rgba(0,255,136,0.15); }
    .section-title .icon.swot { background: rgba(168,85,247,0.15); }

    .section-winner {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-winner.a { background: var(--country-a-bg); color: var(--country-a); border: 1px solid rgba(0,212,255,0.3); }
    .section-winner.b { background: var(--country-b-bg); color: var(--country-b); border: 1px solid rgba(168,85,247,0.3); }
    .section-winner.tie { background: var(--bg-input); color: var(--text-dim); border: 1px solid var(--border); }

    /* ==================== COST CHART ==================== */
    .cost-chart-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 100%;
      overflow: hidden;
    }

    .chart-wrapper {
      height: 300px;
      position: relative;
      min-width: 0;
      max-width: 100%;
      overflow: hidden;
    }

    .cost-legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-dim);
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .legend-divider {
      color: var(--border);
      margin: 0 8px;
    }

    .legend-item.metric {
      display: flex;
      gap: 16px;
    }

    .legend-metric-label {
      font-size: 10px;
      color: var(--text-dim);
      padding: 4px 8px;
      background: var(--bg-input);
      border-radius: 4px;
    }

    /* ==================== PIE CHARTS ==================== */
    .pie-charts-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 24px;
      max-width: 100%;
    }

    .pie-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
    }

    .pie-card.a { border-color: rgba(0,212,255,0.2); }
    .pie-card.b { border-color: rgba(168,85,247,0.2); }

    .pie-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .pie-country-name {
      font-size: 14px;
      font-weight: 700;
    }

    .pie-card.a .pie-country-name { color: var(--country-a); }
    .pie-card.b .pie-country-name { color: var(--country-b); }

    .opportunity-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
    }

    .opportunity-badge.high { background: rgba(0,255,136,0.15); color: var(--success); }
    .opportunity-badge.medium { background: rgba(255,170,0,0.15); color: var(--warning); }
    .opportunity-badge.low { background: rgba(255,68,102,0.15); color: var(--danger); }

    .pie-chart-wrapper {
      height: 180px;
      margin-bottom: 16px;
    }

    .pie-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .pie-stat {
      background: var(--bg-input);
      border-radius: 8px;
      padding: 12px;
    }

    .pie-stat-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .pie-stat-value {
      font-size: 18px;
      font-weight: 700;
    }

    .pie-stat-value.local { color: var(--warning); }
    .pie-stat-value.import { color: var(--success); }

    /* ==================== SMART INSIGHT CARDS ==================== */
    .smart-insight {
      background: rgba(0,255,136,0.06);
      border-left: 4px solid var(--success);
      border-radius: 0 12px 12px 0;
      padding: 16px 20px;
      margin-top: 20px;
    }

    .smart-insight.caution {
      background: rgba(255,170,0,0.06);
      border-left-color: var(--warning);
    }

    .smart-insight.negative {
      background: rgba(255,68,102,0.06);
      border-left-color: var(--danger);
    }

    .smart-insight.neutral {
      background: rgba(0,212,255,0.06);
      border-left-color: var(--accent);
    }

    .smart-insight-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .smart-insight-icon {
      font-size: 16px;
    }

    .smart-insight-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--success);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .smart-insight.caution .smart-insight-title { color: var(--warning); }
    .smart-insight.negative .smart-insight-title { color: var(--danger); }
    .smart-insight.neutral .smart-insight-title { color: var(--accent); }

    .smart-insight-body {
      font-size: 13px;
      color: var(--text);
      line-height: 1.6;
    }

    .insight-verdict {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      padding: 12px 14px;
      background: rgba(0,0,0,0.25);
      border-radius: 8px;
    }

    .verdict-badge {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .verdict-badge.go { background: var(--success); color: #000; }
    .verdict-badge.caution { background: var(--warning); color: #000; }
    .verdict-badge.stop { background: var(--danger); color: #fff; }

    .verdict-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .insight-details {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .insight-tag {
      padding: 4px 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      font-size: 11px;
      color: var(--text-dim);
    }

    /* ==================== SWOT ANALYSIS ==================== */
    .swot-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 24px;
      max-width: 100%;
    }

    .swot-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
    }

    .swot-card.a { border-color: rgba(0,212,255,0.2); }
    .swot-card.b { border-color: rgba(168,85,247,0.2); }

    .swot-country-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .swot-country-flag {
      font-size: 28px;
    }

    .swot-country-name {
      font-size: 16px;
      font-weight: 700;
    }

    .swot-card.a .swot-country-name { color: var(--country-a); }
    .swot-card.b .swot-country-name { color: var(--country-b); }

    .swot-matrix {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .swot-quadrant {
      background: var(--bg-input);
      border-radius: 12px;
      padding: 14px;
      min-height: 120px;
    }

    .swot-quadrant-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .swot-quadrant-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .swot-quadrant.strengths .swot-quadrant-icon { background: rgba(0,255,136,0.2); }
    .swot-quadrant.weaknesses .swot-quadrant-icon { background: rgba(255,68,102,0.2); }
    .swot-quadrant.opportunities .swot-quadrant-icon { background: rgba(0,212,255,0.2); }
    .swot-quadrant.threats .swot-quadrant-icon { background: rgba(255,170,0,0.2); }

    .swot-quadrant-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .swot-quadrant.strengths .swot-quadrant-title { color: var(--success); }
    .swot-quadrant.weaknesses .swot-quadrant-title { color: var(--danger); }
    .swot-quadrant.opportunities .swot-quadrant-title { color: var(--accent); }
    .swot-quadrant.threats .swot-quadrant-title { color: var(--warning); }

    .swot-items {
      list-style: none;
    }

    .swot-item {
      font-size: 11px;
      color: var(--text-dim);
      padding: 4px 0;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      line-height: 1.4;
    }

    .swot-item::before {
      content: '•';
      color: var(--text-dim);
      flex-shrink: 0;
    }

    /* ==================== ACTION FOOTER ==================== */
    .action-footer {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .action-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
    }

    .action-card.a { border-color: rgba(0,212,255,0.3); }
    .action-card.b { border-color: rgba(168,85,247,0.3); }

    .action-card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .action-btn {
      width: 100%;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .action-btn.a {
      background: linear-gradient(135deg, var(--country-a), var(--cyan));
      color: #000;
    }

    .action-btn.b {
      background: linear-gradient(135deg, var(--purple), var(--country-b));
      color: #fff;
    }

    .action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    /* ==================== EMPTY STATE ==================== */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 40px;
      text-align: center;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 14px;
      color: var(--text-dim);
      max-width: 400px;
      line-height: 1.8;
    }

    .empty-state-steps {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 24px;
      padding: 16px 24px;
      background: var(--bg-card);
      border-radius: 12px;
    }

    .empty-state-steps .step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all 0.3s;
    }

    .empty-state-steps .step.active {
      border-color: var(--success);
      background: rgba(0, 255, 136, 0.1);
    }

    .empty-state-steps .step-num {
      width: 20px;
      height: 20px;
      background: var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
    }

    .empty-state-steps .step.active .step-num {
      background: var(--success);
      color: #000;
    }

    .empty-state-steps .step-text {
      font-size: 12px;
      color: var(--text-dim);
    }

    .empty-state-steps .step.active .step-text {
      color: var(--success);
    }

    .empty-state-steps .step-arrow {
      color: var(--text-dim);
      font-size: 14px;
    }

    /* ==================== MODAL ==================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 500px;
      max-height: 85vh;
      overflow: hidden;
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      font-size: 18px;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-summary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .modal-stat {
      background: var(--bg-card);
      border-radius: 10px;
      padding: 14px;
    }

    .modal-stat-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .modal-stat-value {
      font-size: 14px;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .btn-secondary {
      background: var(--bg-input);
      color: var(--text);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--success), #00cc70);
      color: #000;
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 24px;
      background: var(--success);
      color: #000;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      display: none;
      z-index: 3000;
    }

    .toast.show { display: block; }

    /* ==================== RESPONSIVE DESIGN ==================== */
    @media (max-width: 1024px) {
      .selector-header {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 20px;
      }
      
      .vs-divider {
        flex-direction: row;
        justify-content: center;
      }
      
      .score-header {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .vs-center {
        display: none;
      }
      
      .pie-charts-grid,
      .swot-grid,
      .action-footer {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .duel-content {
        padding: 16px;
      }
      
      .country-score-card {
        padding: 16px;
      }
      
      .score-display {
        font-size: 40px;
      }
      
      .topbar {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 12px;
      }
      
      .page-title {
        font-size: 16px;
      }
      
      .swot-matrix {
        grid-template-columns: 1fr;
      }
    }

    /* ==================== SCROLLBAR STYLING ==================== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-dim);
    }
  </style>
</head>
<body>
  <!-- ==================== TOPBAR ==================== -->
  <header class="topbar">
    <div class="topbar-left">
      <a href="/" class="back-btn"><i data-lucide="arrow-left" class="lucide"></i> Komuta Merkezi</a>
      <h1 class="page-title">
        <span class="icon"><i data-lucide="scale" class="lucide"></i></span>
        <span id="pageMainTitle">Stratejik Karşılaştırma</span>
        <span class="vs-badge" id="comparisonBadge">Head-to-Head Analiz</span>
      </h1>
    </div>
  </header>

  <!-- ==================== TRIPLE SELECTOR ==================== -->
  <div class="selector-header triple">
    <!-- Sector Selector (Primary) -->
    <div class="sector-selector-box">
      <span class="selector-label sector">Sektör Seçin</span>
      <select class="sector-select-main" id="sectorSelect">
        <option value="">Sektör Seçin...</option>
      </select>
      <div class="sector-badge" id="sectorBadge"></div>
    </div>
    
    <!-- Country Selectors -->
    <div class="countries-row">
      <div class="country-selector">
        <span class="selector-label a" id="countryLabelA">Pazar A</span>
        <select class="country-select a" id="countryA" disabled>
          <option value="">Önce sektör seçin...</option>
        </select>
      </div>
      
      <div class="vs-divider">
        <div class="vs-text">↔</div>
        <button class="compare-btn" id="compareBtn" disabled>Karşılaştır</button>
      </div>
      
      <div class="country-selector">
        <span class="selector-label b" id="countryLabelB">Pazar B</span>
        <select class="country-select b" id="countryB" disabled>
          <option value="">Önce sektör seçin...</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ==================== EMPTY STATE ==================== -->
  <div class="empty-state" id="emptyState">
    <div class="icon"><i data-lucide="bar-chart-3" class="lucide"></i></div>
    <h3>Sektör Bazlı Karşılaştırma</h3>
    <p>
      <strong>1.</strong> Önce analiz edilecek sektörü seçin<br>
      <strong>2.</strong> Ardından karşılaştırılacak iki pazarı belirleyin<br>
      <strong>3.</strong> "Karşılaştır" butonuna tıklayın
    </p>
    <div class="empty-state-steps">
      <div class="step" id="stepSector">
        <span class="step-num">1</span>
        <span class="step-text">Sektör</span>
      </div>
      <div class="step-arrow">→</div>
      <div class="step" id="stepCountryA">
        <span class="step-num">2</span>
        <span class="step-text" id="stepTextCountryA">Pazar A</span>
      </div>
      <div class="step-arrow">→</div>
      <div class="step" id="stepCountryB">
        <span class="step-num">3</span>
        <span class="step-text" id="stepTextCountryB">Pazar B</span>
      </div>
    </div>
  </div>

  <!-- ==================== DUEL CONTENT ==================== -->
  <div class="duel-content" id="duelContent">
    <!-- Sector Context Banner -->
    <div class="sector-context-banner" id="sectorBanner">
      <div class="sector-context-left">
        <span class="sector-context-label">Sektör Analizi</span>
        <span class="sector-context-name" id="sectorContextName">-</span>
      </div>
      <div class="sector-context-right">
        <div class="sector-winner-verdict" id="sectorWinnerVerdict">
          <span class="verdict-icon" id="verdictIcon"><i data-lucide="scale" class="lucide"></i></span>
          <span class="verdict-text" id="verdictText">Karşılaştırma bekleniyor...</span>
        </div>
      </div>
    </div>

    <!-- Score Header -->
    <div class="score-header">
      <div class="country-score-card a" id="scoreCardA">
        <div class="winner-badge" id="winnerBadgeA"><i data-lucide="check" class="lucide"></i> Daha Uygun</div>
        <div class="country-flag" id="flagA"><i data-lucide="flag" class="lucide"></i></div>
        <div class="country-name" id="nameA">-</div>
        <div class="country-region" id="regionA">-</div>
        <div class="score-display" id="scoreA">0</div>
        <div class="score-label">Uygunluk Skoru</div>
      </div>
      
      <div class="vs-center">
        <div class="vs-circle">↔</div>
      </div>
      
      <div class="country-score-card b" id="scoreCardB">
        <div class="winner-badge" id="winnerBadgeB"><i data-lucide="check" class="lucide"></i> Daha Uygun</div>
        <div class="country-flag" id="flagB"><i data-lucide="flag" class="lucide"></i></div>
        <div class="country-name" id="nameB">-</div>
        <div class="country-region" id="regionB">-</div>
        <div class="score-display" id="scoreB">0</div>
        <div class="score-label">Uygunluk Skoru</div>
      </div>
    </div>

    <!-- Sector Velocity (Growth & Investment) -->
    <div class="comparison-section">
      <div class="section-header">
        <div class="section-title">
          <span class="icon cost"><i data-lucide="trending-up" class="lucide"></i></span>
          Sektör Dinamikleri (Büyüme & Yatırım)
        </div>
        <div class="section-winner" id="velocityWinner"></div>
      </div>
      <div class="cost-chart-container">
        <div class="chart-wrapper">
          <canvas id="velocityChart"></canvas>
        </div>
        <div class="cost-legend" id="velocityLegend">
          <div class="legend-item country-a">
            <div class="legend-dot" style="background:var(--accent)"></div>
            <span id="legendCountryA">Pazar A</span>
          </div>
          <div class="legend-item country-b">
            <div class="legend-dot" style="background:var(--purple)"></div>
            <span id="legendCountryB">Pazar B</span>
          </div>
          <div class="legend-divider">|</div>
          <div class="legend-item metric">
            <span class="legend-metric-label"><i data-lucide="activity" class="lucide"></i> Büyüme</span>
            <span class="legend-metric-label"><i data-lucide="coins" class="lucide"></i> Yatırım</span>
            <span class="legend-metric-label"><i data-lucide="users" class="lucide"></i> İstihdam</span>
          </div>
        </div>
        <!-- Smart Insight Card for Velocity -->
        <div class="smart-insight" id="velocityInsightCard">
          <div class="smart-insight-header">
            <span class="smart-insight-icon"><i data-lucide="lightbulb" class="lucide"></i></span>
            <span class="smart-insight-title">Sektör Dinamikleri Analizi</span>
          </div>
          <div class="smart-insight-body" id="velocityInsightBody">
            Karşılaştırma yapılıyor...
          </div>
        </div>
      </div>
    </div>

    <!-- Market Volume Comparison -->
    <div class="comparison-section">
      <div class="section-header">
        <div class="section-title">
          <span class="icon cost"><i data-lucide="hand-coins" class="lucide"></i></span>
          Pazar Hacmi (İthalat Değeri)
        </div>
        <div class="section-winner" id="volumeWinner"></div>
      </div>
      <div class="cost-chart-container">
        <div class="chart-wrapper" style="height: 250px;">
          <canvas id="volumeChart"></canvas>
        </div>
        <!-- Smart Insight Card for Volume -->
        <div class="smart-insight" id="volumeInsightCard">
          <div class="smart-insight-header">
            <span class="smart-insight-icon"><i data-lucide="lightbulb" class="lucide"></i></span>
            <span class="smart-insight-title">Pazar Hacmi Analizi</span>
          </div>
          <div class="smart-insight-body" id="volumeInsightBody">
            Karşılaştırma yapılıyor...
          </div>
        </div>
      </div>
    </div>

    <!-- Market Structure -->
    <div class="comparison-section">
      <div class="section-header">
        <div class="section-title">
          <span class="icon market"><i data-lucide="pie-chart" class="lucide"></i></span>
          Pazar Yapısı (Yerel Üretim vs İthalat İhtiyacı)
        </div>
        <div class="section-winner" id="marketWinner"></div>
      </div>
      <div class="pie-charts-grid">
        <div class="pie-card a" id="pieCardA">
          <div class="pie-card-header">
            <span class="pie-country-name" id="pieNameA">-</span>
            <span class="opportunity-badge" id="opportunityA">-</span>
          </div>
          <div class="pie-chart-wrapper">
            <canvas id="pieChartA"></canvas>
          </div>
          <div class="pie-stats">
            <div class="pie-stat">
              <div class="pie-stat-label">Yerel Üretim</div>
              <div class="pie-stat-value local" id="localA">0%</div>
            </div>
            <div class="pie-stat">
              <div class="pie-stat-label">İthalat Fırsatı</div>
              <div class="pie-stat-value import" id="importA">0%</div>
            </div>
          </div>
        </div>
        <div class="pie-card b" id="pieCardB">
          <div class="pie-card-header">
            <span class="pie-country-name" id="pieNameB">-</span>
            <span class="opportunity-badge" id="opportunityB">-</span>
          </div>
          <div class="pie-chart-wrapper">
            <canvas id="pieChartB"></canvas>
          </div>
          <div class="pie-stats">
            <div class="pie-stat">
              <div class="pie-stat-label">Yerel Üretim</div>
              <div class="pie-stat-value local" id="localB">0%</div>
            </div>
            <div class="pie-stat">
              <div class="pie-stat-label">İthalat Fırsatı</div>
              <div class="pie-stat-value import" id="importB">0%</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Smart Insight Card for Market -->
      <div class="smart-insight" id="marketInsightCard">
        <div class="smart-insight-header">
          <span class="smart-insight-icon"><i data-lucide="lightbulb" class="lucide"></i></span>
          <span class="smart-insight-title">Pazar Fırsatı Analizi</span>
        </div>
        <div class="smart-insight-body" id="marketInsightBody">
          Pazar yapısı analiz ediliyor...
        </div>
      </div>
    </div>

    <!-- SWOT Analysis -->
    <div class="comparison-section">
      <div class="section-header">
        <div class="section-title">
          <span class="icon swot"><i data-lucide="target" class="lucide"></i></span>
          Otomatik SWOT Analizi
        </div>
      </div>
      <div class="swot-grid">
        <div class="swot-card a" id="swotCardA">
          <div class="swot-country-header">
            <span class="swot-country-flag" id="swotFlagA"><i data-lucide="flag" class="lucide"></i></span>
            <span class="swot-country-name" id="swotNameA">-</span>
          </div>
          <div class="swot-matrix" id="swotMatrixA"></div>
        </div>
        <div class="swot-card b" id="swotCardB">
          <div class="swot-country-header">
            <span class="swot-country-flag" id="swotFlagB"><i data-lucide="flag" class="lucide"></i></span>
            <span class="swot-country-name" id="swotNameB">-</span>
          </div>
          <div class="swot-matrix" id="swotMatrixB"></div>
        </div>
      </div>
    </div>

    <!-- Action Footer -->
    <div class="action-footer">
      <div class="action-card a">
        <div class="action-card-title">Bu ülkeyi hedef olarak seçin</div>
        <button class="action-btn a" id="selectBtnA">
          <i data-lucide="target" class="lucide"></i> <span id="selectNameA">-</span> Seç
        </button>
      </div>
      <div class="action-card b">
        <div class="action-card-title">Bu ülkeyi hedef olarak seçin</div>
        <button class="action-btn b" id="selectBtnB">
          <i data-lucide="target" class="lucide"></i> <span id="selectNameB">-</span> Seç
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL ==================== -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h3><i data-lucide="clipboard-check" class="lucide"></i> Strateji Onayı</h3>
        <button class="modal-close" id="modalClose">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-summary" id="modalSummary"></div>
        <div class="form-group">
          <label>Karar Durumu</label>
          <select id="decisionStatus">
            <option value="Öncelikli Hedef">Öncelikli Hedef</option>
            <option value="İzleme Listesi">İzleme Listesi</option>
            <option value="Pilot Proje">Pilot Proje</option>
            <option value="Şimdilik Değil">Şimdilik Değil</option>
          </select>
        </div>
        <div class="form-group">
          <label>Yönetici Notu</label>
          <textarea id="managerNote" placeholder="Neden bu ülkeyi seçtiniz?"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelSave">İptal</button>
        <button class="btn btn-primary" id="confirmSave"><i data-lucide="check" class="lucide"></i> Kaydet</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ==================== STATE ====================
    let allCountries = [];
    let allSectors = [];
    let selectedSector = null;
    let countryA = null;
    let countryB = null;
    let sectorDataA = null;
    let sectorDataB = null;
    let comparisonResult = null;
    let charts = {};
    let selectedForSave = null;

    // ==================== MOCK DATA GENERATOR ====================
    function generateMockData(country) {
      const seed = (country.ulke_id || 1) * 1234;
      const random = (min, max) => {
        const x = Math.sin(seed + min) * 10000;
        return min + (x - Math.floor(x)) * (max - min);
      };
      
      return {
        tariffRate: Math.round(random(2, 18)),
        localDistribution: Math.round(random(200, 1200)),
        corporateTax: Math.round(random(10, 35))
      };
    }

    // ==================== SWOT GENERATOR ====================
    function generateSWOT(country) {
      const swot = {
        strengths: [],
        weaknesses: [],
        opportunities: [],
        threats: []
      };

      const lpi = parseFloat(country.lpi_skoru || 0);
      const customs = parseInt(country.gumruk_suresi || 30);
      const agreements = parseInt(country.anlasma_sayisi || 0);
      const risk = country.risk_notu || 'BB';
      const growth = parseFloat(country.sektorel_buyume || 0);
      const population = parseFloat(country.nufus_milyon || 0);
      const inflation = parseFloat(country.enflasyon || 0);
      const localProd = parseFloat(country.yerli_uretim_orani || 50);
      const gdp = parseFloat(country.gsyh_kisi_basi || 0);

      // STRENGTHS
      if (lpi >= 3.8) swot.strengths.push('Yüksek Lojistik Verimliliği');
      if (lpi >= 3.5) swot.strengths.push('Güçlü Altyapı');
      if (customs <= 2) swot.strengths.push('Hızlı Gümrük İşlemleri');
      if (agreements >= 3) swot.strengths.push('Çoklu Ticaret Anlaşması');
      if (['AAA', 'AA'].includes(risk)) swot.strengths.push('Düşük Ticari Risk');
      if (gdp >= 40000) swot.strengths.push('Yüksek Satın Alma Gücü');

      // WEAKNESSES
      if (lpi < 2.5) swot.weaknesses.push('Lojistik Darboğazları');
      if (customs > 10) swot.weaknesses.push('Uzun Gümrük Süreleri');
      if (['C', 'CC', 'CCC', 'D'].includes(risk)) swot.weaknesses.push('Yüksek Ticari Risk');
      if (agreements === 0) swot.weaknesses.push('Ticaret Anlaşması Yok');
      if (gdp < 5000) swot.weaknesses.push('Düşük Alım Gücü');

      // OPPORTUNITIES
      if (growth >= 5) swot.opportunities.push('Yüksek Sektörel Büyüme');
      if (population >= 50) swot.opportunities.push('Geniş Hedef Kitle');
      if (localProd < 40) swot.opportunities.push('Düşük Yerel Rekabet');
      if (inflation < 5) swot.opportunities.push('Stabil Ekonomi');
      if (population >= 100) swot.opportunities.push('Devasa Pazar Potansiyeli');

      // THREATS
      if (inflation >= 10) swot.threats.push('Yüksek Enflasyon Riski');
      if (localProd >= 80) swot.threats.push('Doymuş Yerel Pazar');
      if (['B', 'BB'].includes(risk)) swot.threats.push('Orta Düzey Risk');
      if (growth < 0) swot.threats.push('Daralan Pazar');

      // Default items if empty
      if (swot.strengths.length === 0) swot.strengths.push('Veri yetersiz');
      if (swot.weaknesses.length === 0) swot.weaknesses.push('Veri yetersiz');
      if (swot.opportunities.length === 0) swot.opportunities.push('Veri yetersiz');
      if (swot.threats.length === 0) swot.threats.push('Veri yetersiz');

      return swot;
    }

    // ==================== INIT ====================
    async function init() {
      await Promise.all([loadSectors(), loadCountries()]);
      setupEventListeners();

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    // ==================== LOAD SECTORS ====================
    async function loadSectors() {
      try {
        const response = await fetch('/dashboard/api/sectors');
        const result = await response.json();
        
        if (result.status === 'success' && result.data.sectors) {
          allSectors = result.data.sectors;
          populateSectorDropdown();
        }
      } catch (error) {
        console.error('Error loading sectors:', error);
      }
    }

    // ==================== LOAD COUNTRIES ====================
    async function loadCountries() {
      try {
        const response = await fetch('/api/global-markets');
        const result = await response.json();
        
        if (result.status === 'success' && result.data.countries) {
          allCountries = result.data.countries;
        }
      } catch (error) {
        console.error('Error loading countries:', error);
      }
    }

    // ==================== POPULATE DROPDOWNS ====================
    function populateSectorDropdown() {
      const sectorSelect = document.getElementById('sectorSelect');
      
      allSectors.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.sektor_id;
        opt.textContent = s.sektor_adi;
        sectorSelect.appendChild(opt);
      });
    }

    function populateCountryDropdowns() {
      const selectA = document.getElementById('countryA');
      const selectB = document.getElementById('countryB');
      
      // Clear existing options
      selectA.innerHTML = '<option value="">Ülke Seçin...</option>';
      selectB.innerHTML = '<option value="">Ülke Seçin...</option>';
      
      allCountries.forEach(c => {
        const optA = document.createElement('option');
        optA.value = c.ulke_id;
        optA.textContent = c.ulke_adi;
        selectA.appendChild(optA);
        
        const optB = document.createElement('option');
        optB.value = c.ulke_id;
        optB.textContent = c.ulke_adi;
        selectB.appendChild(optB);
      });
      
      // Enable dropdowns
      selectA.disabled = false;
      selectB.disabled = false;

      updateCountryLabels();
    }

    // ==================== SETUP EVENT LISTENERS ====================
    function setupEventListeners() {
      // Sector selection
      document.getElementById('sectorSelect').addEventListener('change', handleSectorChange);
      
      // Country selections
      document.getElementById('countryA').addEventListener('change', () => { updateStepIndicators(); updateCountryLabels(); });
      document.getElementById('countryB').addEventListener('change', () => { updateStepIndicators(); updateCountryLabels(); });
      
      // Compare button
      document.getElementById('compareBtn').addEventListener('click', startComparison);
      
      // Action buttons
      document.getElementById('selectBtnA').addEventListener('click', () => openSaveModal('A'));
      document.getElementById('selectBtnB').addEventListener('click', () => openSaveModal('B'));
      document.getElementById('modalClose').addEventListener('click', closeModal);
      document.getElementById('cancelSave').addEventListener('click', closeModal);
      document.getElementById('confirmSave').addEventListener('click', saveDecision);
    }

    function updateCountryLabels() {
      const selectA = document.getElementById('countryA');
      const selectB = document.getElementById('countryB');

      const countryASelected = selectA && selectA.value;
      const countryBSelected = selectB && selectB.value;

      const labelA = document.getElementById('countryLabelA');
      const labelB = document.getElementById('countryLabelB');
      const stepTextA = document.getElementById('stepTextCountryA');
      const stepTextB = document.getElementById('stepTextCountryB');

      const nameA = countryASelected ? selectA.options[selectA.selectedIndex]?.textContent : 'Ülke';
      const nameB = countryBSelected ? selectB.options[selectB.selectedIndex]?.textContent : 'Ülke';

      if (labelA) labelA.textContent = nameA || 'Ülke';
      if (labelB) labelB.textContent = nameB || 'Ülke';
      if (stepTextA) stepTextA.textContent = nameA || 'Ülke';
      if (stepTextB) stepTextB.textContent = nameB || 'Ülke';
    }

    // ==================== HANDLE SECTOR CHANGE ====================
    function handleSectorChange(e) {
      const sectorId = e.target.value;
      
      if (sectorId) {
        selectedSector = allSectors.find(s => s.sektor_id == sectorId);
        populateCountryDropdowns();
        
        // Update step indicator
        document.getElementById('stepSector').classList.add('active');
        
        // Show sector badge
        const badge = document.getElementById('sectorBadge');
        badge.textContent = selectedSector.sektor_adi;
        badge.classList.add('show');
      } else {
        selectedSector = null;
        document.getElementById('countryA').disabled = true;
        document.getElementById('countryB').disabled = true;
        document.getElementById('countryA').innerHTML = '<option value="">Önce sektör seçin...</option>';
        document.getElementById('countryB').innerHTML = '<option value="">Önce sektör seçin...</option>';
        document.getElementById('stepSector').classList.remove('active');
        document.getElementById('sectorBadge').classList.remove('show');
      }
      
      updateCompareButtonState();
      updateStepIndicators();
    }

    // ==================== UPDATE UI STATES ====================
    function updateStepIndicators() {
      const sectorSelected = document.getElementById('sectorSelect').value;
      const countryASelected = document.getElementById('countryA').value;
      const countryBSelected = document.getElementById('countryB').value;
      
      // Update step indicators
      document.getElementById('stepSector').classList.toggle('active', !!sectorSelected);
      document.getElementById('stepCountryA').classList.toggle('active', !!countryASelected);
      document.getElementById('stepCountryB').classList.toggle('active', !!countryBSelected);
      
      updateCompareButtonState();
    }

    function updateCompareButtonState() {
      const sectorSelected = document.getElementById('sectorSelect').value;
      const countryASelected = document.getElementById('countryA').value;
      const countryBSelected = document.getElementById('countryB').value;
      
      const btn = document.getElementById('compareBtn');
      btn.disabled = !(sectorSelected && countryASelected && countryBSelected && countryASelected !== countryBSelected);
    }

    // ==================== START COMPARISON ====================
    async function startComparison() {
      const sectorId = document.getElementById('sectorSelect').value;
      const idA = document.getElementById('countryA').value;
      const idB = document.getElementById('countryB').value;
      
      if (!sectorId) {
        alert('Lütfen bir sektör seçin!');
        return;
      }
      
      if (!idA || !idB) {
        alert('Lütfen iki ülke seçin!');
        return;
      }
      
      if (idA === idB) {
        alert('Farklı ülkeler seçin!');
        return;
      }
      
      // Show loading state
      const btn = document.getElementById('compareBtn');
      btn.textContent = 'Yükleniyor...';
      btn.disabled = true;
      
      try {
        // Fetch sector-specific comparison data
        const response = await fetch(`/dashboard/api/sectors/${sectorId}/compare?ulkeA=${idA}&ulkeB=${idB}`);
        const result = await response.json();
        
        if (result.status === 'success') {
          comparisonResult = result.data;
          sectorDataA = result.data.countryA;
          sectorDataB = result.data.countryB;
          
          // Also get general country data
          countryA = allCountries.find(c => c.ulke_id == idA) || { ulke_id: idA, ulke_adi: sectorDataA.ulke_adi };
          countryB = allCountries.find(c => c.ulke_id == idB) || { ulke_id: idB, ulke_adi: sectorDataB.ulke_adi };

          // Some ulke_id values come from mock/global datasets and may not exist in DB.
          // Backend then falls back to 'Ülke A'/'Ülke B'. Override with the actual selected names.
          const selectedNameA = document.getElementById('countryA')?.options[document.getElementById('countryA').selectedIndex]?.textContent;
          const selectedNameB = document.getElementById('countryB')?.options[document.getElementById('countryB').selectedIndex]?.textContent;

          if (selectedNameA && (!sectorDataA?.ulke_adi || sectorDataA.ulke_adi === 'Ülke A' || sectorDataA.ulke_adi === 'Ülke')) {
            sectorDataA.ulke_adi = selectedNameA;
          }
          if (selectedNameB && (!sectorDataB?.ulke_adi || sectorDataB.ulke_adi === 'Ülke B' || sectorDataB.ulke_adi === 'Ülke')) {
            sectorDataB.ulke_adi = selectedNameB;
          }
          if (selectedNameA && (!countryA?.ulke_adi || countryA.ulke_adi === 'Ülke A' || countryA.ulke_adi === 'Ülke')) {
            countryA.ulke_adi = selectedNameA;
          }
          if (selectedNameB && (!countryB?.ulke_adi || countryB.ulke_adi === 'Ülke B' || countryB.ulke_adi === 'Ülke')) {
            countryB.ulke_adi = selectedNameB;
          }
          
          document.getElementById('emptyState').style.display = 'none';
          document.getElementById('duelContent').classList.add('show');
          
          renderComparison();
        } else {
          alert('Veri alınamadı: ' + (result.message || 'Bilinmeyen hata'));
        }
      } catch (error) {
        console.error('Comparison error:', error);
        alert('Karşılaştırma sırasında hata: ' + error.message);
      } finally {
        btn.textContent = 'Karşılaştır';
        btn.disabled = false;
      }
    }

    // ==================== RENDER COMPARISON ====================
    function renderComparison() {
      // Update Page Title with actual country names
      document.getElementById('pageMainTitle').textContent = `${sectorDataA.ulke_adi} vs ${sectorDataB.ulke_adi}`;
      const badge = document.getElementById('comparisonBadge');
      badge.textContent = selectedSector.sektor_adi;
      badge.classList.add('active');
      document.title = `${sectorDataA.ulke_adi} vs ${sectorDataB.ulke_adi} - ${selectedSector.sektor_adi}`;
      
      // Sector Context Banner
      document.getElementById('sectorContextName').textContent = selectedSector.sektor_adi;
      
      // Render Winner Verdict
      renderWinnerVerdict();
      
      // Score Cards - Now using sector scores
      const scoreA = comparisonResult.scores.A || 0;
      const scoreB = comparisonResult.scores.B || 0;
      
      document.getElementById('nameA').textContent = sectorDataA.ulke_adi;
      document.getElementById('nameB').textContent = sectorDataB.ulke_adi;
      document.getElementById('regionA').textContent = selectedSector.sektor_adi;
      document.getElementById('regionB').textContent = selectedSector.sektor_adi;
      document.getElementById('scoreA').textContent = scoreA.toFixed(0);
      document.getElementById('scoreB').textContent = scoreB.toFixed(0);
      
      // Winner badges based on sector comparison
      const winner = comparisonResult.winner;
      if (winner === 'A') {
        document.getElementById('winnerBadgeA').classList.add('show');
        document.getElementById('winnerBadgeB').classList.remove('show');
      } else if (winner === 'B') {
        document.getElementById('winnerBadgeB').classList.add('show');
        document.getElementById('winnerBadgeA').classList.remove('show');
      } else {
        document.getElementById('winnerBadgeA').classList.remove('show');
        document.getElementById('winnerBadgeB').classList.remove('show');
      }

      // Action buttons
      document.getElementById('selectNameA').textContent = sectorDataA.ulke_adi;
      document.getElementById('selectNameB').textContent = sectorDataB.ulke_adi;

      // Render all charts
      renderVelocityChart();
      renderVolumeChart();
      renderPieCharts();
      renderSWOT();

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    // ==================== RENDER WINNER VERDICT ====================
    function renderWinnerVerdict() {
      const verdict = document.getElementById('sectorWinnerVerdict');
      const verdictText = document.getElementById('verdictText');
      const winner = comparisonResult.winner;
      const verdictIcon = document.getElementById('verdictIcon');
      
      verdict.classList.remove('winner-a', 'winner-b', 'tie');
      
      if (winner === 'A') {
        verdict.classList.add('winner-a');
        if (verdictIcon) verdictIcon.innerHTML = '<i data-lucide="award" class="lucide"></i>';
        verdictText.innerHTML = `<strong>${sectorDataA.ulke_adi}</strong> ${selectedSector.sektor_adi} sektöründe stratejik tercih`;
      } else if (winner === 'B') {
        verdict.classList.add('winner-b');
        if (verdictIcon) verdictIcon.innerHTML = '<i data-lucide="award" class="lucide"></i>';
        verdictText.innerHTML = `<strong>${sectorDataB.ulke_adi}</strong> ${selectedSector.sektor_adi} sektöründe stratejik tercih`;
      } else {
        verdict.classList.add('tie');
        if (verdictIcon) verdictIcon.innerHTML = '<i data-lucide="scale" class="lucide"></i>';
        verdictText.innerHTML = `Her iki pazar da ${selectedSector.sektor_adi} için benzer fırsatlar sunuyor`;
      }

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    // ==================== RENDER VELOCITY CHART (Growth & Investment) ====================
    function renderVelocityChart() {
      const growthA = sectorDataA.buyume || 0;
      const growthB = sectorDataB.buyume || 0;
      const investA = sectorDataA.yatirim || 0;
      const investB = sectorDataB.yatirim || 0;
      const employA = sectorDataA.istihdam || 0;
      const employB = sectorDataB.istihdam || 0;
      
      // Normalize investment and employment for chart (scale to match growth %)
      const maxInvest = Math.max(investA, investB, 1);
      const maxEmploy = Math.max(employA, employB, 1);
      const normInvestA = (investA / maxInvest) * Math.max(growthA, growthB, 5);
      const normInvestB = (investB / maxInvest) * Math.max(growthA, growthB, 5);
      const normEmployA = (employA / maxEmploy) * Math.max(growthA, growthB, 5);
      const normEmployB = (employB / maxEmploy) * Math.max(growthA, growthB, 5);
      
      // Velocity winner (growth focused)
      const velocityWinner = document.getElementById('velocityWinner');
      if (growthA > growthB) {
        velocityWinner.className = 'section-winner a';
        velocityWinner.innerHTML = '<i data-lucide="check" class="lucide"></i> ' + sectorDataA.ulke_adi + ' daha hızlı büyüyor';
      } else if (growthB > growthA) {
        velocityWinner.className = 'section-winner b';
        velocityWinner.innerHTML = '<i data-lucide="check" class="lucide"></i> ' + sectorDataB.ulke_adi + ' daha hızlı büyüyor';
      } else {
        velocityWinner.className = 'section-winner tie';
        velocityWinner.innerHTML = '= Benzer büyüme hızı';
      }

      // Update dynamic legend with country names
      updateVelocityLegend();

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      if (charts.velocity) charts.velocity.destroy();
      
      const ctx = document.getElementById('velocityChart').getContext('2d');
      charts.velocity = new Chart(ctx, {
        type: 'bar',
        data: {
          // X-axis: Metrics (Grouped by metric type)
          labels: ['Sektörel Büyüme (%)', 'Yatırım Hacmi', 'İstihdam'],
          datasets: [
            {
              // Country A dataset
              label: sectorDataA.ulke_adi,
              data: [growthA, normInvestA, normEmployA],
              backgroundColor: 'rgba(0,212,255,0.85)',
              borderColor: 'rgba(0,212,255,1)',
              borderWidth: 1,
              borderRadius: { topLeft: 6, topRight: 6, bottomLeft: 0, bottomRight: 0 },
              barPercentage: 0.7,
              categoryPercentage: 0.6
            },
            {
              // Country B dataset
              label: sectorDataB.ulke_adi,
              data: [growthB, normInvestB, normEmployB],
              backgroundColor: 'rgba(168,85,247,0.85)',
              borderColor: 'rgba(168,85,247,1)',
              borderWidth: 1,
              borderRadius: { topLeft: 6, topRight: 6, bottomLeft: 0, bottomRight: 0 },
              barPercentage: 0.7,
              categoryPercentage: 0.6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: '#e8eaed',
                font: { size: 12, weight: '600' },
                usePointStyle: true,
                pointStyle: 'rectRounded',
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: 'rgba(10,13,18,0.95)',
              titleColor: '#e8eaed',
              bodyColor: '#e8eaed',
              borderColor: 'rgba(37,41,49,0.8)',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                title: function(tooltipItems) {
                  return tooltipItems[0].label;
                },
                label: function(ctx) {
                  const country = ctx.dataset.label;
                  const metric = ctx.label;
                  const isCountryA = ctx.datasetIndex === 0;
                  
                  if (metric.includes('Büyüme')) {
                    return `${country}: %${ctx.raw.toFixed(1)}`;
                  } else if (metric.includes('Yatırım')) {
                    const realValue = isCountryA ? investA : investB;
                    return `${country}: $${realValue.toLocaleString()}M`;
                  } else {
                    const realValue = isCountryA ? employA : employB;
                    return `${country}: ${realValue.toLocaleString()}K kişi`;
                  }
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { 
                color: '#e8eaed', 
                font: { weight: '600', size: 11 },
                maxRotation: 0
              }
            },
            y: {
              grid: { color: 'rgba(37,41,49,0.5)' },
              ticks: { color: '#6b7280' },
              beginAtZero: true
            }
          }
        }
      });

      // Update Velocity Insight Card
      updateVelocityInsightCard(growthA, growthB, investA, investB);
    }

    // ==================== UPDATE VELOCITY LEGEND ====================
    function updateVelocityLegend() {
      document.getElementById('legendCountryA').textContent = sectorDataA.ulke_adi;
      document.getElementById('legendCountryB').textContent = sectorDataB.ulke_adi;
    }

    // ==================== RENDER VOLUME CHART (Import Value) ====================
    function renderVolumeChart() {
      const volumeA = sectorDataA.ithalat || 0;
      const volumeB = sectorDataB.ithalat || 0;
      
      // Volume winner
      const volumeWinner = document.getElementById('volumeWinner');
      if (volumeA > volumeB) {
        volumeWinner.className = 'section-winner a';
        volumeWinner.innerHTML = '<i data-lucide="check" class="lucide"></i> ' + sectorDataA.ulke_adi + ' daha büyük pazar';
      } else if (volumeB > volumeA) {
        volumeWinner.className = 'section-winner b';
        volumeWinner.innerHTML = '<i data-lucide="check" class="lucide"></i> ' + sectorDataB.ulke_adi + ' daha büyük pazar';
      } else {
        volumeWinner.className = 'section-winner tie';
        volumeWinner.innerHTML = '= Benzer pazar boyutu';
      }

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      if (charts.volume) charts.volume.destroy();
      
      const ctx = document.getElementById('volumeChart').getContext('2d');
      charts.volume = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Sektörel İthalat Hacmi'],
          datasets: [
            {
              label: sectorDataA.ulke_adi,
              data: [volumeA],
              backgroundColor: 'rgba(0,212,255,0.85)',
              borderColor: 'rgba(0,212,255,1)',
              borderWidth: 1,
              borderRadius: 6,
              barPercentage: 0.6,
              categoryPercentage: 0.7
            },
            {
              label: sectorDataB.ulke_adi,
              data: [volumeB],
              backgroundColor: 'rgba(168,85,247,0.85)',
              borderColor: 'rgba(168,85,247,1)',
              borderWidth: 1,
              borderRadius: 6,
              barPercentage: 0.6,
              categoryPercentage: 0.7
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: '#e8eaed',
                font: { size: 12, weight: '600' },
                usePointStyle: true,
                pointStyle: 'rectRounded',
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: 'rgba(10,13,18,0.95)',
              titleColor: '#e8eaed',
              bodyColor: '#e8eaed',
              borderColor: 'rgba(37,41,49,0.8)',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: function(ctx) {
                  const country = ctx.dataset.label;
                  const value = ctx.raw;
                  const formatted = value >= 1000 ? `$${(value/1000).toFixed(1)}B` : `$${value.toLocaleString()}M`;
                  return `${country}: ${formatted}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(37,41,49,0.5)' },
              ticks: {
                color: '#6b7280',
                callback: v => '$' + (v >= 1000 ? (v/1000).toFixed(1) + 'B' : v + 'M')
              }
            },
            y: {
              grid: { display: false },
              ticks: { color: '#e8eaed', font: { weight: '600' } }
            }
          }
        }
      });

      // Update Volume Insight Card
      updateVolumeInsightCard(volumeA, volumeB);
    }

    // ==================== INSIGHT CARD GENERATORS ====================
    function updateVelocityInsightCard(growthA, growthB, investA, investB) {
      const card = document.getElementById('velocityInsightCard');
      const body = document.getElementById('velocityInsightBody');
      
      const fasterGrower = growthA > growthB ? sectorDataA : sectorDataB;
      const slowerGrower = growthA > growthB ? sectorDataB : sectorDataA;
      const fasterGrowth = Math.max(growthA, growthB);
      const slowerGrowth = Math.min(growthA, growthB);
      
      let insightType = fasterGrowth > 5 ? 'positive' : fasterGrowth > 2 ? 'caution' : 'neutral';
      let verdict = comparisonResult.insights.sectorVelocity;
      
      card.className = `smart-insight ${insightType}`;
      body.innerHTML = `
        <div style="margin-bottom:10px">
          <i data-lucide="info" class="lucide"></i> <strong>Bu grafik ne gösteriyor?</strong> ${selectedSector.sektor_adi} sektöründe büyüme oranı, 
          yatırım hacmi ve istihdam verilerini karşılaştırır.
        </div>
        <div class="insight-verdict">
          <div class="verdict-badge ${insightType === 'positive' ? 'go' : insightType === 'caution' ? 'caution' : 'go'}">
            ${fasterGrowth > 5 ? '<i data-lucide="rocket" class="lucide"></i>' : fasterGrowth > 2 ? '<i data-lucide="trending-up" class="lucide"></i>' : '<i data-lucide="bar-chart-3" class="lucide"></i>'}
          </div>
          <div class="verdict-text">${verdict}</div>
        </div>
        <div class="insight-details">
          <span class="insight-tag"><i data-lucide="trending-up" class="lucide"></i> ${fasterGrower.ulke_adi}: %${fasterGrowth.toFixed(1)} büyüme</span>
          <span class="insight-tag"><i data-lucide="trending-down" class="lucide"></i> ${slowerGrower.ulke_adi}: %${slowerGrowth.toFixed(1)} büyüme</span>
        </div>
      `;

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    function updateVolumeInsightCard(volumeA, volumeB) {
      const card = document.getElementById('volumeInsightCard');
      const body = document.getElementById('volumeInsightBody');
      
      const biggerMarket = volumeA > volumeB ? sectorDataA : sectorDataB;
      const smallerMarket = volumeA > volumeB ? sectorDataB : sectorDataA;
      const biggerVolume = Math.max(volumeA, volumeB);
      const smallerVolume = Math.min(volumeA, volumeB);
      const ratio = smallerVolume > 0 ? (biggerVolume / smallerVolume).toFixed(1) : 'N/A';
      
      let insightType = biggerVolume > 5000 ? 'positive' : biggerVolume > 1000 ? 'caution' : 'neutral';
      let verdict = comparisonResult.insights.marketVolume;
      
      card.className = `smart-insight ${insightType}`;
      body.innerHTML = `
        <div style="margin-bottom:10px">
          <i data-lucide="info" class="lucide"></i> <strong>Bu grafik ne gösteriyor?</strong> ${selectedSector.sektor_adi} sektöründeki toplam 
          ithalat hacmini (pazar büyüklüğü göstergesi) karşılaştırır.
        </div>
        <div class="insight-verdict">
          <div class="verdict-badge ${insightType === 'positive' ? 'go' : insightType === 'caution' ? 'caution' : 'go'}">
            ${biggerVolume > 5000 ? '<i data-lucide="hand-coins" class="lucide"></i>' : biggerVolume > 1000 ? '<i data-lucide="bar-chart-3" class="lucide"></i>' : '<i data-lucide="file-text" class="lucide"></i>'}
          </div>
          <div class="verdict-text">${verdict}</div>
        </div>
        <div class="insight-details">
          <span class="insight-tag"><i data-lucide="hand-coins" class="lucide"></i> ${biggerMarket.ulke_adi}: $${biggerVolume.toLocaleString()}M</span>
          <span class="insight-tag"><i data-lucide="bar-chart-3" class="lucide"></i> Oran: ${ratio}x büyük</span>
        </div>
      `;

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    // ==================== RENDER PIE CHARTS (Market Saturation) ====================
    function renderPieCharts() {
      // Use sector-specific local production data
      const localA = sectorDataA.yerliUretim || 50;
      const localB = sectorDataB.yerliUretim || 50;
      const importA = sectorDataA.ithalatFirsati || (100 - localA);
      const importB = sectorDataB.ithalatFirsati || (100 - localB);
      
      // Update stats
      document.getElementById('pieNameA').textContent = sectorDataA.ulke_adi;
      document.getElementById('pieNameB').textContent = sectorDataB.ulke_adi;
      document.getElementById('localA').textContent = localA.toFixed(0) + '%';
      document.getElementById('localB').textContent = localB.toFixed(0) + '%';
      document.getElementById('importA').textContent = importA.toFixed(0) + '%';
      document.getElementById('importB').textContent = importB.toFixed(0) + '%';
      
      // Opportunity badges
      const oppA = document.getElementById('opportunityA');
      const oppB = document.getElementById('opportunityB');
      
      if (importA >= 60) {
        oppA.innerHTML = '<i data-lucide="check-circle" class="lucide"></i> Yüksek Fırsat';
        oppA.className = 'opportunity-badge high';
      } else if (importA >= 40) {
        oppA.innerHTML = '<i data-lucide="alert-circle" class="lucide"></i> Orta Fırsat';
        oppA.className = 'opportunity-badge medium';
      } else {
        oppA.innerHTML = '<i data-lucide="x-circle" class="lucide"></i> Doymuş';
        oppA.className = 'opportunity-badge low';
      }
      
      if (importB >= 60) {
        oppB.innerHTML = '<i data-lucide="check-circle" class="lucide"></i> Yüksek Fırsat';
        oppB.className = 'opportunity-badge high';
      } else if (importB >= 40) {
        oppB.innerHTML = '<i data-lucide="alert-circle" class="lucide"></i> Orta Fırsat';
        oppB.className = 'opportunity-badge medium';
      } else {
        oppB.innerHTML = '<i data-lucide="x-circle" class="lucide"></i> Doymuş';
        oppB.className = 'opportunity-badge low';
      }

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      // Market winner (based on import opportunity)
      const marketWinner = document.getElementById('marketWinner');
      if (importA > importB) {
        marketWinner.className = 'section-winner a';
        marketWinner.innerHTML = '<i data-lucide="check" class="lucide"></i> ' + sectorDataA.ulke_adi + ' daha açık pazar';
      } else if (importB > importA) {
        marketWinner.className = 'section-winner b';
        marketWinner.innerHTML = '<i data-lucide="check" class="lucide"></i> ' + sectorDataB.ulke_adi + ' daha açık pazar';
      } else {
        marketWinner.className = 'section-winner tie';
        marketWinner.innerHTML = '= Benzer pazar yapısı';
      }

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      // Pie Chart A
      if (charts.pieA) charts.pieA.destroy();
      const ctxA = document.getElementById('pieChartA').getContext('2d');
      charts.pieA = new Chart(ctxA, {
        type: 'doughnut',
        data: {
          labels: ['Yerel Üretim', 'İthalat İhtiyacı'],
          datasets: [{
            data: [localA, importA],
            backgroundColor: [
              'rgba(255,170,0,0.8)',
              importA >= 60 ? 'rgba(0,255,136,0.8)' : 'rgba(107,114,128,0.5)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: { display: false }
          }
        }
      });
      
      // Pie Chart B
      if (charts.pieB) charts.pieB.destroy();
      const ctxB = document.getElementById('pieChartB').getContext('2d');
      charts.pieB = new Chart(ctxB, {
        type: 'doughnut',
        data: {
          labels: ['Yerel Üretim', 'İthalat İhtiyacı'],
          datasets: [{
            data: [localB, importB],
            backgroundColor: [
              'rgba(255,170,0,0.8)',
              importB >= 60 ? 'rgba(0,255,136,0.8)' : 'rgba(107,114,128,0.5)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Update Market Insight Card
      updateMarketInsightCard(importA, importB);
    }

    function updateMarketInsightCard(importA, importB) {
      const card = document.getElementById('marketInsightCard');
      const body = document.getElementById('marketInsightBody');
      
      const betterMarket = importA > importB ? sectorDataA : sectorDataB;
      const betterImport = Math.max(importA, importB);
      const worseImport = Math.min(importA, importB);
      const diff = betterImport - worseImport;
      
      let insightType = 'positive';
      let verdict = '';
      let explanation = '';
      
      if (betterImport >= 60) {
        insightType = 'positive';
        explanation = `<strong>${betterMarket.ulke_adi}</strong> pazarı %${betterImport.toFixed(0)} ithalat fırsatı ile ${selectedSector.sektor_adi} sektöründe yüksek potansiyel sunuyor!`;
        verdict = comparisonResult.insights.marketSaturation;
      } else if (betterImport >= 40) {
        insightType = 'caution';
        explanation = `Her iki pazarda da ${selectedSector.sektor_adi} için orta düzey fırsat var.`;
        verdict = `Yerel üreticiler aktif, ancak hala ithalat için alan mevcut. Farklılaşma stratejisi gerekli.`;
      } else {
        insightType = 'negative';
        explanation = `Her iki pazar da ${selectedSector.sektor_adi} sektöründe yerel üretim ile doymuş durumda.`;
        verdict = `İthalat ihtiyacı düşük. Niş segment veya premium ürünlerle giriş düşünülebilir.`;
      }
      
      card.className = `smart-insight ${insightType}`;
      body.innerHTML = `
        <div style="margin-bottom:10px">
          <i data-lucide="info" class="lucide"></i> <strong>Bu grafik ne gösteriyor?</strong> ${selectedSector.sektor_adi} sektöründe yerel üretim kapasitesi ile 
          ithalat fırsatı oranını gösterir. %60+ ithalat fırsatı = Yüksek pazar potansiyeli.
        </div>
        <div style="margin-bottom:10px">${explanation}</div>
        <div class="insight-verdict">
          <div class="verdict-badge ${insightType === 'positive' ? 'go' : insightType === 'caution' ? 'caution' : 'stop'}">
            ${insightType === 'positive' ? '<i data-lucide="check" class="lucide"></i>' : insightType === 'caution' ? '<i data-lucide="alert-triangle" class="lucide"></i>' : '<i data-lucide="x" class="lucide"></i>'}
          </div>
          <div class="verdict-text">${verdict}</div>
        </div>
        <div class="insight-details">
          <span class="insight-tag"><i data-lucide="factory" class="lucide"></i> ${sectorDataA.ulke_adi}: %${importA.toFixed(0)} açık</span>
          <span class="insight-tag"><i data-lucide="factory" class="lucide"></i> ${sectorDataB.ulke_adi}: %${importB.toFixed(0)} açık</span>
        </div>
      `;

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    // ==================== RENDER SWOT ====================
    function renderSWOT() {
      const swotA = generateSectorSWOT(sectorDataA);
      const swotB = generateSectorSWOT(sectorDataB);
      
      document.getElementById('swotNameA').textContent = sectorDataA.ulke_adi;
      document.getElementById('swotNameB').textContent = sectorDataB.ulke_adi;
      
      document.getElementById('swotMatrixA').innerHTML = renderSWOTMatrix(swotA);
      document.getElementById('swotMatrixB').innerHTML = renderSWOTMatrix(swotB);
    }

    // ==================== SECTOR-SPECIFIC SWOT GENERATOR ====================
    function generateSectorSWOT(data) {
      const swot = {
        strengths: [],
        weaknesses: [],
        opportunities: [],
        threats: []
      };

      const growth = data.buyume || 0;
      const volume = data.ithalat || 0;
      const localProd = data.yerliUretim || 50;
      const importGap = data.ithalatFirsati || (100 - localProd);
      const investment = data.yatirim || 0;
      const employment = data.istihdam || 0;

      // STRENGTHS (Sektör bazlı)
      if (growth >= 5) swot.strengths.push(`Yüksek Sektörel Büyüme (%${growth.toFixed(1)})`);
      if (volume >= 3000) swot.strengths.push(`Büyük Pazar Hacmi ($${volume.toLocaleString()}M)`);
      if (investment >= 500) swot.strengths.push(`Güçlü Yatırım Ortamı ($${investment}M)`);
      if (employment >= 200) swot.strengths.push(`Geniş Sektörel İşgücü (${employment}K)`);

      // WEAKNESSES (Sektör bazlı)
      if (growth < 0) swot.weaknesses.push(`Daralan Sektör (%${growth.toFixed(1)})`);
      if (localProd >= 80) swot.weaknesses.push(`Yüksek Yerel Rekabet (%${localProd.toFixed(0)})`);
      if (volume < 500) swot.weaknesses.push(`Küçük Pazar Hacmi ($${volume}M)`);
      if (investment < 100) swot.weaknesses.push(`Düşük Yatırım İlgisi`);

      // OPPORTUNITIES (Sektör bazlı)
      if (importGap >= 60) swot.opportunities.push(`Yüksek İthalat Fırsatı (%${importGap.toFixed(0)})`);
      if (growth >= 3 && growth < 5) swot.opportunities.push(`İstikrarlı Büyüme Trendi`);
      if (localProd < 40) swot.opportunities.push(`Düşük Yerel Rekabet`);
      if (volume >= 1000 && volume < 3000) swot.opportunities.push(`Gelişen Pazar`);

      // THREATS (Sektör bazlı)
      if (importGap < 30) swot.threats.push(`Sınırlı İthalat Alanı (%${importGap.toFixed(0)})`);
      if (growth >= 8) swot.threats.push(`Aşırı Rekabet Potansiyeli`);
      if (localProd >= 60 && localProd < 80) swot.threats.push(`Güçlenen Yerel Üretim`);

      // Default items if empty
      if (swot.strengths.length === 0) swot.strengths.push('Veri yetersiz');
      if (swot.weaknesses.length === 0) swot.weaknesses.push('Belirgin zayıflık yok');
      if (swot.opportunities.length === 0) swot.opportunities.push('Standart pazar koşulları');
      if (swot.threats.length === 0) swot.threats.push('Düşük risk ortamı');

      return swot;
    }

    function renderSWOTMatrix(swot) {
      return `
        <div class="swot-quadrant strengths">
          <div class="swot-quadrant-header">
            <div class="swot-quadrant-icon"><i data-lucide="shield" class="lucide"></i></div>
            <span class="swot-quadrant-title">Güçlü Yönler</span>
          </div>
          <ul class="swot-items">
            ${swot.strengths.map(s => `<li class="swot-item">${s}</li>`).join('')}
          </ul>
        </div>
        <div class="swot-quadrant weaknesses">
          <div class="swot-quadrant-header">
            <div class="swot-quadrant-icon"><i data-lucide="alert-triangle" class="lucide"></i></div>
            <span class="swot-quadrant-title">Zayıf Yönler</span>
          </div>
          <ul class="swot-items">
            ${swot.weaknesses.map(w => `<li class="swot-item">${w}</li>`).join('')}
          </ul>
        </div>
        <div class="swot-quadrant opportunities">
          <div class="swot-quadrant-header">
            <div class="swot-quadrant-icon"><i data-lucide="rocket" class="lucide"></i></div>
            <span class="swot-quadrant-title">Fırsatlar</span>
          </div>
          <ul class="swot-items">
            ${swot.opportunities.map(o => `<li class="swot-item">${o}</li>`).join('')}
          </ul>
        </div>
        <div class="swot-quadrant threats">
          <div class="swot-quadrant-header">
            <div class="swot-quadrant-icon"><i data-lucide="ban" class="lucide"></i></div>
            <span class="swot-quadrant-title">Tehditler</span>
          </div>
          <ul class="swot-items">
            ${swot.threats.map(t => `<li class="swot-item">${t}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    // ==================== MODAL ====================
    function openSaveModal(side) {
      const selectedData = side === 'A' ? sectorDataA : sectorDataB;
      const otherData = side === 'A' ? sectorDataB : sectorDataA;
      const score = side === 'A' ? comparisonResult.scores.A : comparisonResult.scores.B;
      const otherScore = side === 'A' ? comparisonResult.scores.B : comparisonResult.scores.A;
      
      selectedForSave = {
        ...selectedData,
        ulke_id: side === 'A' ? document.getElementById('countryA').value : document.getElementById('countryB').value,
        sektor_id: selectedSector.sektor_id,
        sektor_adi: selectedSector.sektor_adi,
        totalScore: score
      };
      
      document.getElementById('modalSummary').innerHTML = `
        <div class="modal-stat">
          <div class="modal-stat-label">Seçilen Ülke</div>
          <div class="modal-stat-value">${selectedData.ulke_adi}</div>
        </div>
        <div class="modal-stat">
          <div class="modal-stat-label">Sektör</div>
          <div class="modal-stat-value" style="color:var(--purple)">${selectedSector.sektor_adi}</div>
        </div>
        <div class="modal-stat">
          <div class="modal-stat-label">Sektör Skoru</div>
          <div class="modal-stat-value" style="color:var(--accent)">${score.toFixed(0)}/100</div>
        </div>
        <div class="modal-stat">
          <div class="modal-stat-label">Karşılaştırma Sonucu</div>
          <div class="modal-stat-value" style="color:var(--success)">
            ${comparisonResult.winner === side ? '<i data-lucide="check" class="lucide"></i> Stratejik Tercih' : comparisonResult.winner === 'TIE' ? '<i data-lucide="scale" class="lucide"></i> Eşit' : '<i data-lucide="circle" class="lucide"></i> Alternatif'}
          </div>
        </div>
      `;

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      document.getElementById('modalOverlay').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('show');
      selectedForSave = null;
    }

    async function saveDecision() {
      if (!selectedForSave) return;
      
      const status = document.getElementById('decisionStatus').value;
      const note = document.getElementById('managerNote').value;
      const saveBtn = document.getElementById('confirmSave');
      
      // Loading state
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Kaydediliyor...';
      saveBtn.disabled = true;
      
      const payload = {
        ulke_id: selectedForSave.ulke_id,
        ulke_adi: selectedForSave.ulke_adi,
        sektor_id: selectedForSave.sektor_id,
        sektor_adi: selectedForSave.sektor_adi,
        karar_durumu: status,
        yonetici_notu: note || `${sectorDataA.ulke_adi} vs ${sectorDataB.ulke_adi} karşılaştırması - ${selectedSector.sektor_adi} sektörü. ${comparisonResult.winnerReason}`,
        hesaplanan_skor: selectedForSave.totalScore || 0
      };
      
      console.log('Frontend gönderilen veri:', payload);
      
      try {
        const response = await fetch('/api/decisions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        console.log('Backend yanıtı:', result);

        if (response.ok && result.status === 'success') {
          closeModal();
          showToast('Strateji başarıyla kaydedildi (ID: ' + result.data?.id + ')');
        } else {
          console.error('API Hatası:', result);
          showToast('Hata: ' + (result.message || 'Bilinmeyen hata'));
        }
      } catch (error) {
        console.error('Save error:', error);
        showToast('Bağlantı hatası: ' + error.message);
      } finally {
        // Reset button
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3500);
    }

    // ==================== START ====================
    init();
  </script>
</body>
</html>

