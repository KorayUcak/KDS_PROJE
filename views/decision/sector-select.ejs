<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Outfit', sans-serif;
      background: #1a1a2e;
      color: #fff;
      min-height: 100vh;
    }

    .app {
      display: grid;
      grid-template-columns: 340px 1fr;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: #16213e;
      padding: 1.5rem;
      overflow-y: auto;
      border-right: 1px solid rgba(255,255,255,0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding-bottom: 1.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .logo span { font-size: 2rem; }
    .logo h1 { font-size: 1.5rem; font-weight: 700; color: #4cc9f0; }

    /* Filter Sections */
    .filter-section {
      margin-bottom: 1.5rem;
    }

    .filter-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: rgba(255,255,255,0.4);
      margin-bottom: 0.8rem;
    }

    /* Select Dropdowns */
    select {
      width: 100%;
      padding: 0.8rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 0.5rem;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
    }

    select:focus {
      outline: none;
      border-color: #4cc9f0;
    }

    select option {
      background: #16213e;
      color: #fff;
    }

    /* Checkboxes Grid */
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 0.8rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 0.4rem;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .checkbox-item:hover {
      border-color: rgba(76, 201, 240, 0.3);
    }

    .checkbox-item.active {
      background: rgba(76, 201, 240, 0.15);
      border-color: #4cc9f0;
    }

    .checkbox-item input { display: none; }

    /* Range Sliders */
    .range-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .range-label { font-size: 0.85rem; color: rgba(255,255,255,0.7); }
    .range-value { font-size: 0.85rem; color: #4cc9f0; font-weight: 600; }

    input[type="range"] {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      appearance: none;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 14px;
      height: 14px;
      background: #4cc9f0;
      border-radius: 50%;
      cursor: pointer;
    }

    /* Apply Button */
    .apply-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #4cc9f0, #4895ef);
      border: none;
      border-radius: 0.5rem;
      color: #000;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
      transition: transform 0.2s;
    }

    .apply-btn:hover {
      transform: scale(1.02);
    }

    /* Main Area */
    .main-area {
      display: flex;
      flex-direction: column;
    }

    /* Map */
    #map {
      flex: 1;
      min-height: 400px;
    }

    .leaflet-container { background: #0f0f23; }

    /* Results Bar */
    .results-bar {
      background: #16213e;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 2rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .result-stat {
      text-align: center;
    }

    .result-stat .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #4cc9f0;
    }

    .result-stat .label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
    }

    .results-list {
      flex: 1;
      display: flex;
      gap: 0.8rem;
      overflow-x: auto;
      padding: 0.5rem 0;
    }

    .result-card {
      flex-shrink: 0;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 0.5rem;
      padding: 0.8rem 1rem;
      min-width: 140px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: inherit;
    }

    .result-card:hover {
      border-color: #4cc9f0;
      background: rgba(76, 201, 240, 0.1);
    }

    .result-card .rank {
      display: inline-block;
      width: 20px;
      height: 20px;
      background: #4cc9f0;
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
      font-size: 0.7rem;
      font-weight: 700;
      color: #000;
      margin-right: 0.5rem;
    }

    .result-card .name {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .result-card .score {
      font-size: 1.2rem;
      font-weight: 700;
      color: #4cc9f0;
      margin-top: 0.3rem;
    }

    /* Legend */
    .map-legend {
      position: absolute;
      bottom: 80px;
      right: 20px;
      background: rgba(22, 33, 62, 0.95);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 0.5rem;
      padding: 1rem;
      z-index: 1000;
      font-size: 0.75rem;
    }

    .legend-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.3rem 0;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
      }
      .sidebar {
        max-height: 50vh;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar Filters -->
    <aside class="sidebar">
      <div class="logo">
        <span>üåç</span>
        <h1>KDS</h1>
      </div>

      <!-- Sector -->
      <div class="filter-section">
        <div class="filter-title">üì¶ Sekt√∂r</div>
        <select id="sectorSelect">
          <% sectors.forEach((s, i) => { %>
            <option value="<%= s.sektor_id %>" <%= i === 0 ? 'selected' : '' %>><%= s.sektor_adi %></option>
          <% }); %>
        </select>
      </div>

      <!-- Region -->
      <div class="filter-section">
        <div class="filter-title">üó∫Ô∏è B√∂lge</div>
        <select id="regionSelect">
          <option value="">T√ºm B√∂lgeler</option>
          <% regions.forEach(r => { %>
            <option value="<%= r.bolge_id %>"><%= r.bolge_adi %></option>
          <% }); %>
        </select>
      </div>

      <!-- Risk Rating -->
      <div class="filter-section">
        <div class="filter-title">‚ö†Ô∏è Risk Notu</div>
        <div class="checkbox-grid">
          <% 
            const riskGroups = {
              'AAA-A': ['AAA', 'AA+', 'AA', 'AA-', 'A+', 'A', 'A-'],
              'BBB': ['BBB+', 'BBB', 'BBB-'],
              'BB': ['BB+', 'BB', 'BB-'],
              'B-C': ['B+', 'B', 'B-', 'CCC', 'CC', 'C', 'D']
            };
          %>
          <label class="checkbox-item active" data-risk="high-grade">
            <input type="checkbox" checked> üü¢ AAA-A
          </label>
          <label class="checkbox-item active" data-risk="investment">
            <input type="checkbox" checked> üü° BBB
          </label>
          <label class="checkbox-item" data-risk="speculative">
            <input type="checkbox"> üü† BB
          </label>
          <label class="checkbox-item" data-risk="high-risk">
            <input type="checkbox"> üî¥ B-C
          </label>
        </div>
      </div>

      <!-- Trade Agreement -->
      <div class="filter-section">
        <div class="filter-title">üìú Ticaret Anla≈ümasƒ±</div>
        <select id="agreementSelect">
          <option value="">T√ºm√º</option>
          <% agreements.forEach(a => { %>
            <option value="<%= a.anlasma_id %>"><%= a.anlasma_adi %></option>
          <% }); %>
        </select>
      </div>

      <!-- GDP Per Capita -->
      <div class="filter-section">
        <div class="filter-title">üí∞ Ki≈üi Ba≈üƒ± GSYƒ∞H</div>
        <div class="range-row">
          <span class="range-label">Min</span>
          <span class="range-value" id="gdpMinVal">$0</span>
        </div>
        <input type="range" id="gdpMin" min="0" max="<%= Math.round(parseFloat(economicStats.max_gdp_per_capita || 100000)) %>" value="0" oninput="updateRange('gdpMin')">
        <div class="range-row" style="margin-top: 0.8rem;">
          <span class="range-label">Max</span>
          <span class="range-value" id="gdpMaxVal">$<%= Math.round(parseFloat(economicStats.max_gdp_per_capita || 100000)).toLocaleString() %></span>
        </div>
        <input type="range" id="gdpMax" min="0" max="<%= Math.round(parseFloat(economicStats.max_gdp_per_capita || 100000)) %>" value="<%= Math.round(parseFloat(economicStats.max_gdp_per_capita || 100000)) %>" oninput="updateRange('gdpMax')">
      </div>

      <!-- Population -->
      <div class="filter-section">
        <div class="filter-title">üë• N√ºfus (Milyon)</div>
        <div class="range-row">
          <span class="range-label">Min</span>
          <span class="range-value" id="popMinVal">0</span>
        </div>
        <input type="range" id="popMin" min="0" max="<%= Math.round(parseFloat(economicStats.max_population || 1500)) %>" value="0" oninput="updateRange('popMin')">
      </div>

      <!-- LPI Score -->
      <div class="filter-section">
        <div class="filter-title">üöö LPI Skoru (Lojistik)</div>
        <div class="range-row">
          <span class="range-label">Min</span>
          <span class="range-value" id="lpiMinVal"><%= parseFloat(logisticsStats.min_lpi || 1).toFixed(1) %></span>
        </div>
        <input type="range" id="lpiMin" min="<%= parseFloat(logisticsStats.min_lpi || 1) %>" max="<%= parseFloat(logisticsStats.max_lpi || 5) %>" value="<%= parseFloat(logisticsStats.min_lpi || 1) %>" step="0.1" oninput="updateRange('lpiMin')">
      </div>

      <!-- Customs Time -->
      <div class="filter-section">
        <div class="filter-title">‚è±Ô∏è Max G√ºmr√ºk S√ºresi (G√ºn)</div>
        <div class="range-row">
          <span class="range-label">Max</span>
          <span class="range-value" id="customsMaxVal"><%= parseInt(logisticsStats.max_customs || 30) %></span>
        </div>
        <input type="range" id="customsMax" min="1" max="<%= parseInt(logisticsStats.max_customs || 30) %>" value="<%= parseInt(logisticsStats.max_customs || 30) %>" oninput="updateRange('customsMax')">
      </div>

      <!-- Shipping Cost -->
      <div class="filter-section">
        <div class="filter-title">üì¶ Max Nakliye Maliyeti ($)</div>
        <div class="range-row">
          <span class="range-label">Max</span>
          <span class="range-value" id="shippingMaxVal">$<%= parseInt(logisticsStats.max_shipping || 10000).toLocaleString() %></span>
        </div>
        <input type="range" id="shippingMax" min="500" max="<%= parseInt(logisticsStats.max_shipping || 10000) %>" value="<%= parseInt(logisticsStats.max_shipping || 10000) %>" step="100" oninput="updateRange('shippingMax')">
      </div>

      <!-- Minimum Score -->
      <div class="filter-section">
        <div class="filter-title">üéØ Minimum Skor</div>
        <div class="range-row">
          <span class="range-label">En Az</span>
          <span class="range-value" id="minScoreVal">30</span>
        </div>
        <input type="range" id="minScore" min="0" max="80" value="30" oninput="updateRange('minScore')">
      </div>

      <button class="apply-btn" onclick="applyFilters()">
        üîç √úlkeleri Bul
      </button>
    </aside>

    <!-- Main Map Area -->
    <main class="main-area">
      <div id="map"></div>

      <!-- Legend -->
      <div class="map-legend">
        <div class="legend-title">Skor</div>
        <div class="legend-item"><div class="legend-color" style="background: #00ff88;"></div> 80+ √áok Uygun</div>
        <div class="legend-item"><div class="legend-color" style="background: #4cc9f0;"></div> 65-79 Uygun</div>
        <div class="legend-item"><div class="legend-color" style="background: #ffc107;"></div> 50-64 Potansiyel</div>
        <div class="legend-item"><div class="legend-color" style="background: #ff9800;"></div> 35-49 Riskli</div>
      </div>

      <!-- Results Bar -->
      <div class="results-bar">
        <div class="result-stat">
          <div class="value" id="countryCount">0</div>
          <div class="label">Uygun √úlke</div>
        </div>
        <div class="result-stat">
          <div class="value" id="avgScore">0</div>
          <div class="label">Ort. Skor</div>
        </div>
        <div class="results-list" id="resultsList">
          <!-- Filled by JS -->
        </div>
      </div>
    </main>
  </div>

  <script>
    // Country coordinates
    const coords = {
      'TR': [39, 35], 'DE': [51, 9], 'FR': [46, 2], 'GB': [54, -2], 'IT': [42, 12],
      'ES': [40, -4], 'NL': [52, 5], 'BE': [50.5, 4], 'PL': [52, 20], 'CZ': [50, 15],
      'AT': [47.5, 14], 'CH': [47, 8], 'SE': [62, 15], 'NO': [62, 10], 'DK': [56, 10],
      'FI': [64, 26], 'RU': [60, 100], 'UA': [49, 32], 'RO': [46, 25], 'GR': [39, 22],
      'PT': [39.5, -8], 'HU': [47, 20], 'IE': [53, -8], 'SK': [48.5, 19.5],
      'US': [38, -97], 'CA': [56, -106], 'MX': [23, -102], 'BR': [-14, -51],
      'AR': [-34, -64], 'CL': [-35, -71], 'CO': [4, -72], 'PE': [-10, -76],
      'CN': [35, 105], 'JP': [36, 138], 'KR': [36, 128], 'IN': [20, 77],
      'ID': [-5, 120], 'TH': [15, 100], 'VN': [16, 108], 'MY': [4, 101.5],
      'SG': [1.3, 103.8], 'PH': [13, 122], 'AU': [-27, 133], 'NZ': [-41, 174],
      'ZA': [-30, 25], 'EG': [27, 30], 'NG': [10, 8], 'KE': [0, 38],
      'MA': [32, -5], 'SA': [24, 45], 'AE': [24, 54], 'IL': [31, 35],
      'QA': [25.5, 51], 'KW': [29.5, 47.5], 'PK': [30, 70], 'BD': [24, 90]
    };

    // Risk groups
    const riskGroups = {
      'high-grade': ['AAA', 'AA+', 'AA', 'AA-', 'A+', 'A', 'A-'],
      'investment': ['BBB+', 'BBB', 'BBB-'],
      'speculative': ['BB+', 'BB', 'BB-'],
      'high-risk': ['B+', 'B', 'B-', 'CCC', 'CC', 'C', 'D']
    };

    // Init map
    const map = L.map('map', { center: [30, 20], zoom: 2, minZoom: 2 });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    let markers = [];
    let allData = [];

    // Toggle checkboxes
    document.querySelectorAll('.checkbox-item').forEach(item => {
      item.addEventListener('click', () => item.classList.toggle('active'));
    });

    // Update range display
    function updateRange(id) {
      const input = document.getElementById(id);
      const val = input.value;
      const display = document.getElementById(id + 'Val');
      
      if (id.includes('gdp')) {
        display.textContent = '$' + parseInt(val).toLocaleString();
      } else if (id === 'shippingMax') {
        display.textContent = '$' + parseInt(val).toLocaleString();
      } else if (id === 'lpiMin') {
        display.textContent = parseFloat(val).toFixed(1);
      } else {
        display.textContent = val;
      }
    }

    // Get score color
    function getColor(score) {
      if (score >= 80) return '#00ff88';
      if (score >= 65) return '#4cc9f0';
      if (score >= 50) return '#ffc107';
      if (score >= 35) return '#ff9800';
      return '#f44336';
    }

    // Apply filters
    async function applyFilters() {
      const sektorId = document.getElementById('sectorSelect').value;
      const bolgeId = document.getElementById('regionSelect').value;
      const agreementId = document.getElementById('agreementSelect').value;
      
      // Get active risk groups
      const activeRisks = [];
      document.querySelectorAll('.checkbox-item.active').forEach(item => {
        const group = item.dataset.risk;
        if (riskGroups[group]) {
          activeRisks.push(...riskGroups[group]);
        }
      });

      // Get range values
      const gdpMin = parseInt(document.getElementById('gdpMin').value);
      const gdpMax = parseInt(document.getElementById('gdpMax').value);
      const popMin = parseInt(document.getElementById('popMin').value);
      const lpiMin = parseFloat(document.getElementById('lpiMin').value);
      const customsMax = parseInt(document.getElementById('customsMax').value);
      const shippingMax = parseInt(document.getElementById('shippingMax').value);
      const minScore = parseInt(document.getElementById('minScore').value);

      try {
        const res = await fetch(`/api/sector/${sektorId}/rankings`);
        const data = await res.json();

        if (data.status === 'success') {
          // Filter data
          allData = data.data.rankings.filter(c => {
            // Score filter
            if (c.totalScore < minScore) return false;
            
            // Region filter
            if (bolgeId && c.bolge_id != bolgeId) return false;
            
            // Risk filter
            if (activeRisks.length > 0 && !activeRisks.includes(c.risk_notu)) return false;
            
            // GDP per capita
            const gdp = parseFloat(c.gsyh_kisi_basi) || 0;
            if (gdp < gdpMin || gdp > gdpMax) return false;
            
            // Population
            const pop = parseFloat(c.nufus) || 0;
            if (pop < popMin) return false;
            
            // LPI Score
            const lpi = parseFloat(c.lpi_skoru) || 0;
            if (lpi > 0 && lpi < lpiMin) return false;
            
            // Customs time
            const customs = parseInt(c.gumruk_suresi) || 0;
            if (customs > 0 && customs > customsMax) return false;
            
            // Shipping cost
            const shipping = parseInt(c.konteyner_maliyeti) || 0;
            if (shipping > 0 && shipping > shippingMax) return false;

            return true;
          });

          updateMap(allData);
          updateResults(allData, sektorId);
        }
      } catch (err) {
        console.error('Error:', err);
      }
    }

    // Update map
    function updateMap(countries) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      countries.forEach(c => {
        const pos = coords[c.ISO_KODU];
        if (!pos) return;

        const color = getColor(c.totalScore);
        const marker = L.circleMarker(pos, {
          radius: 8 + (c.totalScore / 15),
          fillColor: color,
          fillOpacity: 0.8,
          color: '#fff',
          weight: 2
        }).addTo(map);

        marker.bindPopup(`
          <div style="text-align:center; padding:0.5rem;">
            <strong style="font-size:1.1rem;">${c.ulke_adi}</strong><br>
            <span style="font-size:1.5rem; font-weight:bold; color:${color};">${c.totalScore}</span><br>
            <a href="/sector/${document.getElementById('sectorSelect').value}/country/${c.ulke_id}" 
               style="display:inline-block; margin-top:0.5rem; padding:0.4rem 1rem; background:#4cc9f0; color:#000; text-decoration:none; border-radius:4px; font-weight:600;">
              Detay
            </a>
          </div>
        `);

        markers.push(marker);
      });

      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    // Update results
    function updateResults(countries, sektorId) {
      document.getElementById('countryCount').textContent = countries.length;
      
      const avg = countries.length > 0 
        ? Math.round(countries.reduce((s, c) => s + c.totalScore, 0) / countries.length)
        : 0;
      document.getElementById('avgScore').textContent = avg;

      const list = document.getElementById('resultsList');
      list.innerHTML = countries.slice(0, 10).map((c, i) => `
        <a href="/sector/${sektorId}/country/${c.ulke_id}" class="result-card">
          <span class="rank">${i + 1}</span>
          <span class="name">${c.ulke_adi}</span>
          <div class="score">${c.totalScore}</div>
        </a>
      `).join('');
    }

    // Initial load
    applyFilters();
  </script>
</body>
</html>
