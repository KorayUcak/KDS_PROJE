<%- include('../includes/dashboard-header') %>

<div class="dashboard-container">
  <!-- Sayfa BaÅŸlÄ±ÄŸÄ± -->
  <div class="page-header">
    <h1>ğŸ“Š Genel BakÄ±ÅŸ</h1>
    <p class="page-subtitle">KÃ¼resel Pazar AraÅŸtÄ±rmasÄ± Karar Destek Sistemi - GerÃ§ek ZamanlÄ± Global Ã–zet</p>
  </div>

  <!-- KPI KartlarÄ± - GerÃ§ek ZamanlÄ± Global Ã–zet -->
  <section class="kpi-section">
    <div class="kpi-grid">
      <!-- 1. KÃ¼resel Pazar Hacmi -->
      <div class="kpi-card">
        <div class="kpi-icon blue">
          <span>ğŸŒ</span>
        </div>
        <div class="kpi-content">
          <h3 class="kpi-value"><%= stats.globalGDPFormatted %></h3>
          <p class="kpi-label">KÃ¼resel Pazar Hacmi</p>
          <span class="kpi-trend positive">
            <span>ğŸŒ</span> <%= stats.totalCountries %> Ã¼lke GSYÄ°H toplamÄ±
          </span>
        </div>
      </div>

      <!-- 2. Ortalama BÃ¼yÃ¼me -->
      <div class="kpi-card">
        <div class="kpi-icon green">
          <span>ğŸ“ˆ</span>
        </div>
        <div class="kpi-content">
          <h3 class="kpi-value">%<%= stats.avgGrowth %></h3>
          <p class="kpi-label">Ortalama BÃ¼yÃ¼me</p>
          <span class="kpi-trend positive">
            <span>â†‘</span> YÄ±llÄ±k ekonomik bÃ¼yÃ¼me
          </span>
        </div>
      </div>

      <!-- 3. En YÃ¼ksek Enflasyon -->
      <div class="kpi-card">
        <div class="kpi-icon orange">
          <span>ğŸ”¥</span>
        </div>
        <div class="kpi-content">
          <h3 class="kpi-value">%<%= stats.maxInflation %></h3>
          <p class="kpi-label">En YÃ¼ksek Enflasyon</p>
          <span class="kpi-trend negative">
            <span>âš ï¸</span> <%= stats.maxInflationCountry %>
          </span>
        </div>
      </div>

      <!-- 4. Toplam NÃ¼fus -->
      <div class="kpi-card">
        <div class="kpi-icon purple">
          <span>ğŸ‘¥</span>
        </div>
        <div class="kpi-content">
          <h3 class="kpi-value"><%= stats.totalPopulationFormatted %></h3>
          <p class="kpi-label">Toplam NÃ¼fus</p>
          <span class="kpi-trend">
            <span>ğŸ¯</span> Pazar bÃ¼yÃ¼klÃ¼ÄŸÃ¼
          </span>
        </div>
      </div>
    </div>
  </section>

  <% if (hasData) { %>
    <!-- ========================================== -->
    <!-- VERÄ° VAR - Harita, Grafik ve Tablo GÃ¶ster -->
    <!-- ========================================== -->
    <section class="main-grid">
      <!-- DÃ¼nya HaritasÄ± -->
      <div class="grid-item map-section">
        <div class="card">
          <div class="card-header">
            <h2>ğŸ—ºï¸ Pazar HaritasÄ±</h2>
            <span class="card-subtitle">Analiz edilen Ã¼lkeler</span>
          </div>
          <div class="card-body map-card-body">
            <div id="world-map" class="world-map map-container"></div>
          </div>
        </div>
      </div>

      <!-- Yatay Bar Chart - 17 Ãœlke GSYÄ°H -->
      <div class="grid-item chart-section">
        <div class="card">
          <div class="card-header">
            <h2>ğŸ“Š Ãœlkelerin Ekonomik BÃ¼yÃ¼klÃ¼kleri (GSYÄ°H)</h2>
            <span class="card-subtitle">17 Ã¼lke - Milyar $ (BÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe sÄ±ralÄ±)</span>
          </div>
          <div class="card-body" style="min-height: 550px;">
            <canvas id="gdpChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Son Analizler Tablosu -->
      <div class="grid-item table-section">
        <div class="card">
          <div class="card-header">
            <h2>ğŸ“‹ Son Analizler</h2>
            <a href="/analyses/new" class="view-all-link">+ Yeni Analiz â†’</a>
          </div>
          <div class="card-body">
            <% if (recentAnalyses && recentAnalyses.length > 0) { %>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ãœlke</th>
                  <th>SektÃ¶r</th>
                  <th>Durum</th>
                  <th>Tarih</th>
                </tr>
              </thead>
              <tbody>
                <% recentAnalyses.forEach(function(analysis) { %>
                  <tr>
                    <td><strong><%= analysis.ulke_adi || 'Bilinmiyor' %></strong></td>
                    <td><%= analysis.sektor_adi || '-' %></td>
                    <td>
                      <span class="status-badge <%= analysis.hesaplanan_skor ? 'status-tamamlandi' : 'status-taslak' %>">
                        <%= analysis.hesaplanan_skor ? 'âœ“ TamamlandÄ±' : 'â³ Bekliyor' %>
                      </span>
                    </td>
                    <td><%= analysis.olusturulma_tarihi ? new Date(analysis.olusturulma_tarihi).toLocaleDateString('tr-TR') : '-' %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
            <% } else { %>
            <div class="empty-table-message">
              <p>HenÃ¼z analiz kaydÄ± yok. <a href="/analyses/new">Yeni analiz oluÅŸturun â†’</a></p>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </section>

    <!-- JavaScript: Harita ve Grafik (Sadece veri varsa) -->
    <script>
      const mapData = <%- mapData %>;
      const gdpData = <%- gdpData %>;

      // Harita - GSYÄ°H deÄŸerleriyle
      $(document).ready(function() {
        if (Object.keys(mapData).length > 0) {
          $('#world-map').vectorMap({
            map: 'world_mill_en',
            backgroundColor: 'transparent',
            zoomOnScroll: false,
            regionStyle: {
              initial: {
                fill: '#e4e4e4',
                'fill-opacity': 1,
                stroke: '#ffffff',
                'stroke-width': 1
              },
              hover: { 'fill-opacity': 0.8, cursor: 'pointer' }
            },
            series: {
              regions: [{
                values: mapData,
                scale: ['#C8EEFF', '#0071A4'],
                normalizeFunction: 'polynomial'
              }]
            },
            onRegionTipShow: function(e, el, code) {
              if (mapData[code]) {
                el.html(el.html() + '<br><strong>GSYÄ°H: $' + mapData[code].toLocaleString('tr-TR') + ' Milyar</strong>');
              }
            }
          });
        }
      });

      // Yatay Bar Chart - 17 Ãœlke GSYÄ°H
      if (gdpData.labels && gdpData.labels.length > 0) {
        const ctx = document.getElementById('gdpChart');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: gdpData.labels,
            datasets: [{
              label: 'GSYÄ°H (Milyar $)',
              data: gdpData.data,
              backgroundColor: gdpData.backgroundColors,
              borderRadius: 4,
              borderSkipped: false
            }]
          },
          options: {
            indexAxis: 'y', // YATAY BAR CHART
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return '$' + context.raw.toLocaleString('tr-TR') + ' Milyar';
                  }
                }
              }
            },
            scales: {
              x: { 
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.05)' },
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString('tr-TR');
                  }
                }
              },
              y: { 
                grid: { display: false },
                ticks: {
                  font: { size: 12, weight: '500' }
                }
              }
            }
          }
        });
      }
    </script>

  <% } else { %>
    <!-- ========================================== -->
    <!-- VERÄ° YOK - Empty State / KarÅŸÄ±lama EkranÄ± -->
    <!-- ========================================== -->
    <section class="empty-state-section">
      <div class="empty-state-card">
        <div class="empty-state-icon">ğŸš€</div>
        <h2>HoÅŸ Geldiniz!</h2>
        <p class="empty-state-message">
          HenÃ¼z hiÃ§ pazar analizi yapmadÄ±nÄ±z. Ä°lk analizinizi oluÅŸturarak 
          kÃ¼resel pazarlarÄ± keÅŸfetmeye baÅŸlayÄ±n.
        </p>
        <div class="empty-state-features">
          <div class="feature-item">
            <span class="feature-icon">ğŸŒ</span>
            <span>50+ Ãœlke Verisi</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">ğŸ“Š</span>
            <span>7 Analiz Tipi</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">ğŸ“ˆ</span>
            <span>DetaylÄ± Raporlar</span>
          </div>
        </div>
        <a href="/analyses/new" class="btn btn-primary btn-lg">
          â• Yeni Analiz BaÅŸlat
        </a>
      </div>
    </section>
  <% } %>
</div>

<%- include('../includes/dashboard-footer') %>
