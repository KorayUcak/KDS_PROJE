<%- include('../includes/dashboard-header') %>

<div class="dashboard-container">
  <div class="page-header">
    <h1>üìã Yeni Analiz Ekle</h1>
    <p class="page-subtitle">Sekt√∂r ve √ºlke bazlƒ± pazar analizi olu≈üturun</p>
  </div>

  <!-- ƒ∞statistik Kartlarƒ± -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üåç</div>
      <div class="stat-content">
        <div class="stat-value"><%= countries.length %></div>
        <div class="stat-label">√úlke Se√ßeneƒüi</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üè≠</div>
      <div class="stat-content">
        <div class="stat-value"><%= sectors.length %></div>
        <div class="stat-label">Sekt√∂r Se√ßeneƒüi</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-content">
        <div class="stat-value"><%= countries.length * sectors.length %></div>
        <div class="stat-label">Analiz Kombinasyonu</div>
      </div>
    </div>
  </div>

  <!-- Bilgilendirme Kartƒ± -->
  <div class="info-banner">
    <div class="info-icon">üí°</div>
    <div class="info-content">
      <h4>Analiz Olu≈üturma Rehberi</h4>
      <p>Hedef √ºlke ve sekt√∂r se√ßerek detaylƒ± pazar analizi olu≈üturabilirsiniz. Sistem otomatik olarak ekonomik verileri, sekt√∂rel metrikleri ve pazar fƒ±rsatlarƒ±nƒ± analiz edecektir.</p>
    </div>
  </div>

  <section class="form-section">
    <div class="form-card">
      <form id="analysisForm" class="analysis-form">
        <!-- ADIM 1: Sekt√∂r Se√ßimi -->
        <div class="form-step" id="step1">
          <div class="step-header">
            <div class="step-number">1</div>
            <h3 class="step-title">Sekt√∂r Se√ßimi</h3>
          </div>
          <div class="form-group">
            <label for="sektor_id">
              Hedef Sekt√∂r <span class="required">*</span>
              <span class="field-hint">Analiz yapmak istediƒüiniz sekt√∂r√º se√ßin</span>
            </label>
            <select id="sektor_id" name="sektor_id" required>
              <option value="">-- Sekt√∂r Se√ßiniz --</option>
              <% if (typeof sectors !== 'undefined' && sectors.length > 0) { %>
                <% sectors.forEach(function(sector) { %>
                  <option value="<%= sector.sektor_id %>"><%= sector.sektor_adi %></option>
                <% }); %>
              <% } else { %>
                <option value="" disabled>Sekt√∂r verisi bulunamadƒ±</option>
              <% } %>
            </select>
            <div class="validation-message" id="sektor-error"></div>
          </div>
        </div>

        <!-- ADIM 2: √úlke Se√ßimi -->
        <div class="form-step" id="step2">
          <div class="step-header">
            <div class="step-number">2</div>
            <h3 class="step-title">√úlke Se√ßimi</h3>
          </div>
          <div class="form-group">
            <label for="ulke_id">
              Hedef √úlke <span class="required">*</span>
              <span class="field-hint">Analiz yapmak istediƒüiniz √ºlkeyi se√ßin</span>
            </label>
            <div class="search-wrapper">
              <input 
                type="text" 
                id="ulke_search" 
                placeholder="üîç √úlke ara..."
                class="search-input"
              >
            </div>
            <select id="ulke_id" name="ulke_id" required size="8" class="country-select">
              <% if (typeof countries !== 'undefined' && countries.length > 0) { %>
                <% countries.forEach(function(country) { %>
                  <option 
                    value="<%= country.ulke_id %>" 
                    data-iso="<%= country.ISO_KODU %>"
                    data-name="<%= country.ulke_adi.toLowerCase() %>">
                    <%= country.ulke_adi %> (<%= country.ISO_KODU %>)
                  </option>
                <% }); %>
              <% } else { %>
                <option value="" disabled>√úlke verisi bulunamadƒ±</option>
              <% } %>
            </select>
            <div class="validation-message" id="ulke-error"></div>
          </div>
        </div>

        <!-- ADIM 3: Analiz Detaylarƒ± -->
        <div class="form-step" id="step3">
          <div class="step-header">
            <div class="step-number">3</div>
            <h3 class="step-title">Analiz Detaylarƒ±</h3>
          </div>
          
          <div class="form-group">
            <label for="aciklama">
              A√ßƒ±klama / Notlar
              <span class="field-hint">Analiz hakkƒ±nda ek bilgiler ekleyebilirsiniz (opsiyonel)</span>
            </label>
            <textarea 
              id="aciklama" 
              name="aciklama" 
              rows="4"
              maxlength="500"
              placeholder="√ñrn: 2024 yƒ±lƒ± i√ßin otomotiv sekt√∂r√º yatƒ±rƒ±m fƒ±rsatlarƒ± analizi..."
            ></textarea>
            <div class="char-counter">
              <span id="char-count">0</span> / 500 karakter
            </div>
          </div>

          <div class="form-group">
            <label for="yonetici_notu">
              Y√∂netici Notu
              <span class="field-hint">Analiz i√ßin √∂zel notlar (opsiyonel)</span>
            </label>
            <textarea 
              id="yonetici_notu" 
              name="yonetici_notu" 
              rows="3"
              maxlength="300"
              placeholder="Y√∂netici i√ßin √∂zel notlar..."
            ></textarea>
            <div class="char-counter">
              <span id="note-count">0</span> / 300 karakter
            </div>
          </div>
        </div>

        <!-- Se√ßim √ñzeti -->
        <div class="selection-summary" id="summary" style="display: none;">
          <h4>üìã Se√ßim √ñzeti</h4>
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label">Sekt√∂r:</span>
              <span class="summary-value" id="summary-sektor">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">√úlke:</span>
              <span class="summary-value" id="summary-ulke">-</span>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <a href="/analyses/dashboard" class="btn btn-secondary">‚Üê ƒ∞ptal</a>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span class="btn-icon">üìä</span>
            <span class="btn-text">Analiz Olu≈ütur</span>
          </button>
        </div>
      </form>
    </div>
  </section>
</div>

<style>
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 2rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }

  .stat-icon {
    font-size: 3.5rem;
    opacity: 0.9;
  }

  .stat-content {
    flex: 1;
    color: white;
  }

  .stat-value {
    font-size: 2.8rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
  }

  .stat-label {
    font-size: 1.3rem;
    opacity: 0.9;
    font-weight: 500;
  }

  .info-banner {
    background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
    border-left: 4px solid #3b82f6;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 3rem;
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
  }

  .info-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
  }

  .info-content h4 {
    color: #1e40af;
    margin: 0 0 0.5rem 0;
    font-size: 1.6rem;
  }

  .info-content p {
    color: #1e3a8a;
    margin: 0;
    font-size: 1.4rem;
    line-height: 1.6;
  }

  .form-section {
    max-width: 900px;
    margin: 0 auto;
  }

  .form-card {
    background: #fff;
    border-radius: 1.2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 3rem;
  }

  .form-step {
    margin-bottom: 3rem;
    padding-bottom: 2.5rem;
    border-bottom: 2px solid #e2e8f0;
  }

  .form-step:last-of-type {
    border-bottom: none;
    margin-bottom: 2rem;
  }

  .step-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .step-number {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    font-weight: 700;
    flex-shrink: 0;
  }

  .step-title {
    font-size: 2rem;
    color: #2d3748;
    margin: 0;
    font-weight: 700;
  }

  .form-group {
    margin-bottom: 2rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.8rem;
    color: #2d3748;
    font-size: 1.5rem;
  }

  .required {
    color: #ef4444;
    font-weight: 700;
  }

  .field-hint {
    display: block;
    font-size: 1.2rem;
    color: #718096;
    font-weight: 400;
    margin-top: 0.3rem;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 1.2rem 1.5rem;
    font-size: 1.4rem;
    border: 2px solid #e2e8f0;
    border-radius: 0.8rem;
    transition: all 0.2s;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .search-wrapper {
    margin-bottom: 1rem;
  }

  .search-input {
    width: 100%;
    padding: 1rem 1.5rem;
    font-size: 1.4rem;
    border: 2px solid #e2e8f0;
    border-radius: 0.8rem;
    transition: all 0.2s;
  }

  .search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .country-select {
    height: auto !important;
    min-height: 300px;
    overflow-y: auto;
  }

  .country-select option {
    padding: 1rem;
    cursor: pointer;
  }

  .country-select option:hover {
    background: #f3f4f6;
  }

  .country-select option:checked {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .char-counter {
    text-align: right;
    font-size: 1.2rem;
    color: #718096;
    margin-top: 0.5rem;
  }

  .validation-message {
    color: #ef4444;
    font-size: 1.3rem;
    margin-top: 0.5rem;
    display: none;
  }

  .validation-message.show {
    display: block;
  }

  .selection-summary {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border-left: 4px solid #22c55e;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .selection-summary h4 {
    color: #15803d;
    margin: 0 0 1.5rem 0;
    font-size: 1.6rem;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
  }

  .summary-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .summary-label {
    font-size: 1.2rem;
    color: #166534;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .summary-value {
    font-size: 1.5rem;
    color: #15803d;
    font-weight: 700;
  }

  .form-actions {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn {
    padding: 1.2rem 2.5rem;
    font-size: 1.5rem;
    font-weight: 600;
    border-radius: 0.8rem;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 0.8rem;
    text-decoration: none;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border: 2px solid #e5e7eb;
  }

  .btn-secondary:hover {
    background: #e5e7eb;
  }

  .btn-icon {
    font-size: 1.8rem;
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }

    .form-card {
      padding: 2rem;
    }

    .form-actions {
      flex-direction: column;
    }

    .btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<script>
  // Karakter sayacƒ±
  const aciklamaTextarea = document.getElementById('aciklama');
  const charCount = document.getElementById('char-count');
  const yoneticiNotuTextarea = document.getElementById('yonetici_notu');
  const noteCount = document.getElementById('note-count');

  aciklamaTextarea.addEventListener('input', () => {
    charCount.textContent = aciklamaTextarea.value.length;
  });

  yoneticiNotuTextarea.addEventListener('input', () => {
    noteCount.textContent = yoneticiNotuTextarea.value.length;
  });

  // √úlke arama fonksiyonu
  const ulkeSearch = document.getElementById('ulke_search');
  const ulkeSelect = document.getElementById('ulke_id');
  const allOptions = Array.from(ulkeSelect.options);

  ulkeSearch.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    
    allOptions.forEach(option => {
      const countryName = option.dataset.name || '';
      if (countryName.includes(searchTerm)) {
        option.style.display = '';
      } else {
        option.style.display = 'none';
      }
    });
  });

  // Se√ßim √∂zeti g√ºncelleme
  const sektorSelect = document.getElementById('sektor_id');
  const summaryDiv = document.getElementById('summary');
  const summarySektorSpan = document.getElementById('summary-sektor');
  const summaryUlkeSpan = document.getElementById('summary-ulke');

  function updateSummary() {
    const sektorText = sektorSelect.options[sektorSelect.selectedIndex]?.text || '-';
    const ulkeText = ulkeSelect.options[ulkeSelect.selectedIndex]?.text || '-';
    
    if (sektorSelect.value && ulkeSelect.value) {
      summarySektorSpan.textContent = sektorText;
      summaryUlkeSpan.textContent = ulkeText;
      summaryDiv.style.display = 'block';
    } else {
      summaryDiv.style.display = 'none';
    }
  }

  sektorSelect.addEventListener('change', updateSummary);
  ulkeSelect.addEventListener('change', updateSummary);

  // Form validasyonu ve g√∂nderimi
  const form = document.getElementById('analysisForm');
  const submitBtn = document.getElementById('submitBtn');
  const sektorError = document.getElementById('sektor-error');
  const ulkeError = document.getElementById('ulke-error');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validasyon mesajlarƒ±nƒ± temizle
    sektorError.classList.remove('show');
    ulkeError.classList.remove('show');

    // Se√ßilen sekt√∂r bilgilerini al
    const sektorId = sektorSelect.value;
    const sektorAdi = sektorSelect.options[sektorSelect.selectedIndex].text;

    // Se√ßilen √ºlke bilgilerini al
    const ulkeId = ulkeSelect.value;
    const ulkeOption = ulkeSelect.options[ulkeSelect.selectedIndex];
    const ulkeAdi = ulkeOption.text.split(' (')[0];
    const ulkeKodu = ulkeOption.dataset.iso;

    // Validasyon
    let hasError = false;

    if (!sektorId) {
      sektorError.textContent = '‚ö†Ô∏è L√ºtfen bir sekt√∂r se√ßiniz.';
      sektorError.classList.add('show');
      hasError = true;
    }

    if (!ulkeId) {
      ulkeError.textContent = '‚ö†Ô∏è L√ºtfen bir √ºlke se√ßiniz.';
      ulkeError.classList.add('show');
      hasError = true;
    }

    if (hasError) {
      return;
    }

    // Buton durumunu deƒüi≈ütir
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Olu≈üturuluyor...</span>';

    const formData = {
      kullanici_id: 1, // TODO: Session'dan alƒ±nacak
      parametreler: {
        hedef_sektor_id: parseInt(sektorId),
        hedef_ulke_id: parseInt(ulkeId),
        sektor: sektorAdi,
        ulke: ulkeAdi,
        ulke_kodu: ulkeKodu,
        aciklama: aciklamaTextarea.value.trim() || null,
        yonetici_notu: yoneticiNotuTextarea.value.trim() || null
      }
    };

    try {
      const response = await fetch('/analyses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      const data = await response.json();

      if (data.status === 'success') {
        // Ba≈üarƒ±lƒ± mesajƒ± g√∂ster
        submitBtn.innerHTML = '<span class="btn-icon">‚úÖ</span><span class="btn-text">Ba≈üarƒ±lƒ±!</span>';
        
        // Kƒ±sa bir gecikme sonrasƒ± y√∂nlendir
        setTimeout(() => {
          window.location.href = '/analyses/dashboard';
        }, 1000);
      } else {
        throw new Error(data.message || 'Analiz olu≈üturulamadƒ±');
      }
    } catch (error) {
      console.error('Hata:', error);
      alert('‚ùå Bir hata olu≈ütu: ' + error.message);
      
      // Buton durumunu eski haline getir
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="btn-icon">üìä</span><span class="btn-text">Analiz Olu≈ütur</span>';
    }
  });
</script>

<%- include('../includes/dashboard-footer') %>
